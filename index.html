<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Florida Homes - Tampa, Orlando, Lakeland & Daytona Listings</title>
    <meta name="description" content="Explore 10,000+ Central Florida homes across Tampa, Orlando, Lakeland and Daytona Beach. Live alerts, map view, comparisons, and neighborhood insights to help you move fast.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #0066CC;
            --primary-dark: #004C99;
            --secondary-green: #34A853;
            --accent-orange: #FF6B35;
            --accent-purple: #6B46C1;
            --accent-teal: #14B8A6;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --bg-gray: #F9FAFB;
            --white: #FFFFFF;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.12);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.18);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
            background: var(--white);
            padding-bottom: 120px;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        button {
            font-family: inherit;
        }

        .live-notifications {
            position: fixed;
            top: 84px;
            right: 24px;
            z-index: 1100;
            max-width: 360px;
        }

        .notification-item {
            background: var(--white);
            border-left: 4px solid var(--secondary-green);
            padding: 16px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.35s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(320px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-icon {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary-green), var(--accent-teal));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-content { flex: 1; }
        .notification-name { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
        .notification-action { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        .notification-time { font-size: 12px; color: var(--text-secondary); opacity: 0.65; }

        .top-banner {
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-orange));
            color: var(--white);
            padding: 12px 24px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
        }

        .top-banner a { text-decoration: underline; margin-left: 8px; }

        .header {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i { font-size: 30px; }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .header-btn {
            background: var(--primary-blue);
            color: var(--white);
            padding: 10px 22px;
            border-radius: 10px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .header-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .saved-searches-btn {
            background: transparent;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
            position: relative;
        }

        .saved-searches-btn:hover {
            background: var(--primary-blue);
            color: var(--white);
        }

        .saved-count {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent-orange);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }

        .hero {
            background: linear-gradient(rgba(15, 23, 42, 0.45), rgba(15, 23, 42, 0.6)),
                        url('https://images.unsplash.com/photo-1560518883-ce09059eeffa?auto=format&fit=crop&w=2000&q=85') center/cover;
            color: var(--white);
            text-align: center;
            padding: 120px 24px 90px;
        }

        .hero-content { max-width: 900px; margin: 0 auto; }
        .hero-title { font-size: 56px; font-weight: 900; margin-bottom: 18px; line-height: 1.12; text-shadow: 0 8px 20px rgba(0,0,0,0.45); }
        .hero-subtitle { font-size: 20px; font-weight: 500; opacity: 0.95; margin-bottom: 36px; }

        .hero-cta-buttons { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; margin-bottom: 30px; }
        .hero-cta-btn { display: inline-flex; align-items: center; gap: 10px; border-radius: 999px; padding: 14px 28px; font-weight: 700; font-size: 16px; border: none; cursor: pointer; box-shadow: 0 14px 32px rgba(0,0,0,0.25); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .hero-cta-btn.primary { background: linear-gradient(135deg, var(--accent-orange), #f97316); color: var(--white); }
        .hero-cta-btn.secondary { background: rgba(255,255,255,0.12); color: var(--white); border: 1px solid rgba(255,255,255,0.45); box-shadow: none; }
        .hero-cta-btn:hover { transform: translateY(-3px); box-shadow: 0 18px 30px rgba(0,0,0,0.35); }

        .search-container {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-xl);
            margin-bottom: 36px;
        }

        .search-tabs {
            display: flex;
            gap: 12px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .search-tab {
            background: transparent;
            border: none;
            padding: 12px 24px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: color 0.2s ease, border-color 0.2s ease;
        }

        .search-tab.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }

        .search-hint {
            margin-left: auto;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            opacity: 0.9;
            display: none;
        }

        @media (min-width: 768px) {
            .search-hint { display: inline-block; }
        }

        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            text-align: left;
        }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .form-select, .form-input { padding: 12px; border-radius: 10px; border: 2px solid var(--border-color); font-size: 15px; transition: border-color 0.2s ease; }
        .form-select:focus, .form-input:focus { outline: none; border-color: var(--primary-blue); }

        .search-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin-top: 12px;
        }

        .search-btn {
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .search-btn:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
        .save-search-btn { background: transparent; color: var(--primary-blue); border: 2px solid var(--primary-blue); }
        .save-search-btn:hover { background: var(--primary-blue); color: var(--white); }

        .hero-stats { display: flex; justify-content: center; gap: 48px; flex-wrap: wrap; }
        .hero-stat { text-align: center; }
        .hero-stat-value { font-size: 36px; font-weight: 900; display: block; }
        .hero-stat-label { font-size: 14px; opacity: 0.85; }

        .view-toggle {
            max-width: 1400px;
            margin: 40px auto 20px;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .property-count { font-size: 18px; font-weight: 600; }

        .view-buttons {
            display: flex;
            background: var(--white);
            border-radius: 12px;
            padding: 4px;
            box-shadow: var(--shadow-sm);
            gap: 6px;
        }

        .view-btn {
            border: none;
            background: transparent;
            padding: 10px 22px;
            border-radius: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .view-btn.active { background: var(--primary-blue); color: var(--white); }

        .map-layout {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px 40px;
            display: none;
            gap: 24px;
            grid-template-columns: 2fr 1fr;
            align-items: stretch;
        }

        .map-layout.active { display: grid; }

        .map-wrapper {
            position: relative;
            min-height: 620px;
        }

        #propertyMap {
            height: 100%;
            width: 100%;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            display: block;
        }

        .map-status {
            position: absolute;
            top: 32px;
            left: 40px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 18px;
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
            font-weight: 600;
            color: var(--text-secondary);
            display: none;
        }

        .map-controls {
            position: absolute;
            top: 24px;
            right: 40px;
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 8px;
        }

        .map-control-btn {
            background: var(--white);
            border: 2px solid var(--border-color);
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        .map-control-btn:hover { background: var(--bg-gray); }
        .map-control-btn.active { background: var(--accent-orange); color: var(--white); border-color: var(--accent-orange); }

        .map-sidebar {
            background: var(--white);
            border-radius: 18px;
            padding: 24px 0 16px;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .map-sidebar-header {
            padding: 0 24px 18px;
            border-bottom: 1px solid var(--border-color);
        }

        .map-sidebar-count {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .map-sidebar-summary {
            font-size: 22px;
            font-weight: 800;
            margin-top: 6px;
            color: var(--text-primary);
        }

        .map-sidebar-list {
            overflow-y: auto;
            padding: 20px 16px 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .map-sidebar-card {
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            gap: 14px;
            transition: box-shadow 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
            cursor: pointer;
        }

        .map-sidebar-card:hover {
            transform: translateY(-2px);
            border-color: rgba(37,99,235,0.45);
            box-shadow: var(--shadow-sm);
        }

        .map-sidebar-card.active {
            border-color: rgba(37,99,235,0.8);
            background: rgba(37,99,235,0.08);
            box-shadow: var(--shadow-sm);
        }

        .map-sidebar-empty {
            padding: 18px;
            text-align: center;
            color: var(--text-secondary);
            font-weight: 600;
            border: 1px dashed var(--border-color);
            border-radius: 14px;
        }

        .map-sidebar-card img {
            width: 110px;
            height: 88px;
            object-fit: cover;
            border-radius: 12px;
            flex-shrink: 0;
            background-color: #E5E7EB;
        }

        .map-sidebar-info { display: flex; flex-direction: column; gap: 6px; }
        .map-sidebar-price { font-weight: 800; font-size: 18px; color: var(--primary-blue); }
        .map-sidebar-address { font-size: 14px; color: var(--text-secondary); }
        .map-sidebar-meta { display: flex; gap: 12px; font-size: 13px; color: var(--text-secondary); }
        .map-sidebar-actions { margin-top: 10px; display: flex; gap: 8px; }
        .map-sidebar-btn { border: none; padding: 8px 12px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; background: var(--bg-gray); color: var(--text-primary); }
        .map-sidebar-btn.primary { background: var(--primary-blue); color: var(--white); }

        .leaflet-div-icon { background: transparent; border: none; }
        .price-marker-shell { position: relative; transform: translate(-50%, -100%); }

        .price-marker {
            background: rgba(15, 23, 42, 0.92);
            color: var(--white);
            border-radius: 999px;
            padding: 8px 14px;
            font-size: 14px;
            font-weight: 700;
            border: 2px solid rgba(255,255,255,0.5);
            box-shadow: 0 12px 24px rgba(15,23,42,0.25);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .price-marker.highlight {
            background: var(--accent-orange);
            color: var(--white);
            transform: translateY(-4px);
            box-shadow: 0 18px 32px rgba(234,179,8,0.35);
        }

        .properties-section {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px 80px;
        }

        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 32px;
        }

        .properties-section.hidden { display: none; }

        .properties-grid.hidden { display: none; }

        .property-card {
            background: var(--white);
            border-radius: 18px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            position: relative;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .property-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-xl); }

        .property-image { position: relative; height: 260px; overflow: hidden; background: #111827; }
        .property-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            transition: transform 0.25s ease;
        }
        .property-card:hover .property-image img { transform: scale(1.05); }

        .property-badge {
            position: absolute;
            top: 16px;
            left: 16px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: var(--white);
        }

        .badge-new { background: var(--secondary-green); }
        .badge-hot { background: var(--accent-orange); }
        .badge-reduced { background: var(--accent-purple); }
        .badge-pending { background: #F59E0B; }
        .badge-sold { background: #9CA3AF; }

        .compare-checkbox {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 2px solid var(--primary-blue);
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .compare-checkbox:hover,
        .compare-checkbox.active { background: var(--primary-blue); color: var(--white); }

        .favorite-btn {
            position: absolute;
            bottom: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: var(--white);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .favorite-btn i { font-size: 20px; color: var(--accent-orange); }
        .favorite-btn.active i { color: var(--accent-purple); }
        .favorite-btn:hover { transform: scale(1.05); }

        .property-photo-count {
            position: absolute;
            left: 16px;
            bottom: 16px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(15,23,42,0.78);
            color: var(--white);
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .property-info { padding: 22px 24px 20px; }
        .property-price { font-size: 28px; font-weight: 800; color: var(--primary-blue); margin-bottom: 8px; }
        .property-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary); }
        .property-address { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; display: flex; align-items: center; gap: 6px; }

        .property-features {
            display: flex;
            flex-wrap: wrap;
            gap: 14px 20px;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            padding: 14px 0;
            margin-bottom: 16px;
        }

        .feature { display: flex; gap: 6px; font-size: 14px; font-weight: 600; color: var(--text-secondary); }
        .feature i { color: var(--primary-blue); }

        .property-footer { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .property-type { font-size: 13px; color: var(--text-secondary); background: var(--bg-gray); padding: 6px 12px; border-radius: 8px; font-weight: 600; }

        .view-details-btn {
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .view-details-btn:hover { background: var(--primary-dark); }

        .load-more { display: none; justify-content: center; margin-top: 32px; }
        .load-more-btn { background: var(--accent-orange); color: var(--white); border: none; padding: 14px 36px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .load-more-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        .empty-state {
            grid-column: 1 / -1;
            background: var(--bg-gray);
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .comparison-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 2px solid var(--primary-blue);
            padding: 16px 24px;
            box-shadow: 0 -6px 18px rgba(0,0,0,0.12);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1050;
        }

        .comparison-toolbar.active { transform: translateY(0); }

        .comparison-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }

        .comparison-selected { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }

        .selected-property-card {
            background: var(--bg-gray);
            padding: 8px 14px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .selected-property-card img { width: 54px; height: 54px; object-fit: cover; border-radius: 8px; }
        .remove-comparison { background: none; border: none; color: var(--accent-orange); cursor: pointer; font-size: 18px; }
        .comparison-placeholder { color: var(--text-secondary); font-size: 14px; }
        .compare-btn { background: var(--primary-blue); color: var(--white); border: none; padding: 12px 32px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: background 0.2s ease; }
        .compare-btn:disabled { background: var(--border-color); color: var(--text-secondary); cursor: not-allowed; }

        .agent-dashboard-section,
        .market-stats-section,
        .testimonials-section { background: var(--white); padding: 80px 24px; }

        .dashboard-container,
        .section-header,
        .stats-grid,
        .testimonials-grid,
        .neighborhood-container,
        .cities-grid { max-width: 1400px; margin: 0 auto; }

        .dashboard-preview {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-blue));
            border-radius: 24px;
            padding: 48px;
            color: var(--white);
            position: relative;
            overflow: hidden;
        }

        .dashboard-preview::before {
            content: '';
            position: absolute;
            top: -40%;
            right: -25%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.14) 0%, transparent 70%);
            border-radius: 50%;
        }

        .dashboard-header { display: flex; justify-content: space-between; align-items: center; gap: 24px; margin-bottom: 36px; position: relative; z-index: 1; }
        .dashboard-title { font-size: 32px; font-weight: 800; }
        .dashboard-subtitle { margin-top: 6px; opacity: 0.9; }
        .demo-badge { background: var(--accent-orange); padding: 8px 20px; border-radius: 999px; font-weight: 700; letter-spacing: 0.5px; }

        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 24px; margin-bottom: 32px; position: relative; z-index: 1; }
        .dashboard-stat-card { background: rgba(255,255,255,0.12); backdrop-filter: blur(10px); border-radius: 16px; padding: 24px; border: 1px solid rgba(255,255,255,0.2); }
        .dashboard-stat-value { font-size: 36px; font-weight: 900; display: block; margin-bottom: 6px; }

        .dashboard-features { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 18px; position: relative; z-index: 1; }
        .dashboard-feature { display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.12); padding: 16px; border-radius: 12px; }
        .dashboard-feature i { font-size: 20px; }

        .demo-btn { margin-top: 36px; background: var(--accent-orange); color: var(--white); border: none; padding: 16px 48px; border-radius: 12px; font-weight: 700; font-size: 18px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .demo-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.2); }

        .neighborhood-section,
        .cities-section,
        .cta-section { background: var(--bg-gray); padding: 80px 24px; }

        .section-title { font-size: 36px; font-weight: 800; text-align: center; margin-bottom: 48px; }

        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
        .insight-card { background: var(--white); border-radius: 20px; padding: 32px; box-shadow: var(--shadow-md); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .insight-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .insight-icon { width: 60px; height: 60px; border-radius: 16px; background: linear-gradient(135deg, var(--primary-blue), var(--accent-orange)); color: var(--white); display: flex; align-items: center; justify-content: center; font-size: 26px; margin-bottom: 18px; }
        .insight-stats { display: flex; flex-direction: column; gap: 12px; }
        .insight-stat-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .insight-stat-row:last-child { border-bottom: none; }
        .insight-stat-value { font-weight: 700; color: var(--primary-blue); }
        .rating-stars { color: var(--accent-orange); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 28px; }
        .stat-card { background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark)); color: var(--white); padding: 36px; border-radius: 20px; text-align: center; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: -20%; right: -10%; width: 160px; height: 160px; background: rgba(255,255,255,0.12); border-radius: 50%; }
        .stat-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.9; }
        .stat-value { font-size: 42px; font-weight: 900; display: block; margin-bottom: 6px; }
        .stat-description { opacity: 0.85; font-size: 14px; }

        .cities-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 32px; }
        .city-card { background: var(--white); border-radius: 20px; overflow: hidden; box-shadow: var(--shadow-md); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .city-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-xl); }
        .city-image { position: relative; height: 220px; }
        .city-image img { width: 100%; height: 100%; object-fit: cover; }
        .city-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 24px; background: linear-gradient(0deg, rgba(15,23,42,0.85), transparent 80%); color: var(--white); }
        .city-name { font-size: 28px; font-weight: 800; }
        .city-tagline { font-size: 14px; opacity: 0.9; }
        .city-stats { padding: 24px; }
        .city-stat { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .city-stat:last-child { border-bottom: none; }
        .city-stat-value { font-weight: 700; color: var(--primary-blue); }

        .testimonials-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 32px; }
        .testimonial-card { background: var(--white); border-radius: 20px; padding: 32px; box-shadow: var(--shadow-md); border-left: 4px solid var(--primary-blue); }
        .testimonial-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .testimonial-avatar { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-blue), var(--accent-orange)); color: var(--white); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 22px; }
        .testimonial-rating { color: var(--accent-orange); margin-bottom: 12px; }
        .testimonial-text { color: var(--text-secondary); line-height: 1.7; font-style: italic; }

        .cta-section { text-align: center; background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark)); color: var(--white); }
        .cta-content { max-width: 820px; margin: 0 auto; }
        .cta-content h2 { font-size: 42px; font-weight: 900; margin-bottom: 16px; }
        .cta-content p { font-size: 18px; opacity: 0.92; margin-bottom: 28px; }
        .cta-buttons { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; }
        .cta-btn-primary { background: var(--accent-orange); color: var(--white); border: none; padding: 16px 42px; border-radius: 12px; font-weight: 700; font-size: 18px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .cta-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(0,0,0,0.25); }
        .cta-btn-secondary { background: var(--white); color: var(--primary-blue); border: none; padding: 16px 42px; border-radius: 12px; font-weight: 700; font-size: 18px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; display: flex; align-items: center; gap: 10px; }
        .cta-btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(0,0,0,0.25); }

        .footer { background: var(--text-primary); color: var(--white); padding: 70px 24px 24px; }
        .footer-content { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 36px; margin-bottom: 40px; }
        .footer-section h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
        .footer-links { list-style: none; }
        .footer-links li { margin-bottom: 10px; }
        .footer-links a { color: rgba(255,255,255,0.78); }
        .footer-links a:hover { color: var(--white); }
        .social-links { display: flex; gap: 12px; }
        .social-link { width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.14); display: flex; align-items: center; justify-content: center; color: var(--white); transition: transform 0.2s ease, background 0.2s ease; }
        .social-link:hover { transform: translateY(-2px); background: var(--primary-blue); }
        .footer-bottom { max-width: 1400px; margin: 0 auto; text-align: center; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.12); opacity: 0.7; }

        .property-detail-modal .property-detail-content {
            background: var(--white);
            border-radius: 24px;
            width: min(1100px, 94vw);
            max-height: 92vh;
            overflow-y: auto;
            padding: 40px 44px 48px;
            position: relative;
            box-shadow: var(--shadow-xl);
        }

        .property-detail-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 28px; margin-bottom: 32px; }
        .property-detail-city { display: inline-flex; align-items: center; gap: 8px; background: rgba(37,99,235,0.12); color: var(--primary-blue); padding: 6px 14px; border-radius: 999px; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .property-detail-title { font-size: 32px; font-weight: 800; margin: 10px 0 12px; }
        .property-detail-address { color: var(--text-secondary); font-size: 16px; }
        .property-detail-price { font-size: 32px; font-weight: 900; color: var(--primary-blue); }

        .property-detail-body { display: flex; gap: 32px; align-items: flex-start; }
        .property-detail-main { flex: 2; display: flex; flex-direction: column; gap: 28px; }
        .property-detail-sidebar { flex: 1; background: var(--bg-gray); border-radius: 20px; padding: 28px; display: flex; flex-direction: column; gap: 24px; position: sticky; top: 32px; max-height: calc(92vh - 120px); overflow-y: auto; }

        .detail-gallery { display: grid; gap: 16px; }
        .detail-gallery-primary { position: relative; border-radius: 20px; overflow: hidden; }
        .detail-gallery-primary img { width: 100%; height: 420px; object-fit: cover; }
        .detail-gallery-thumbs { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .detail-thumb { border: none; padding: 0; border-radius: 14px; overflow: hidden; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .detail-thumb:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .detail-thumb img { width: 100%; height: 110px; object-fit: cover; display: block; }

        .detail-description-wrap h3 { font-size: 22px; font-weight: 700; margin-bottom: 14px; }
        .detail-description p { color: var(--text-secondary); line-height: 1.7; margin-bottom: 16px; }
        .detail-description p:last-child { margin-bottom: 0; }

        .detail-stats { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; }
        .detail-stat { background: var(--white); border-radius: 14px; padding: 16px; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; gap: 6px; }
        .detail-stat-label { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .detail-stat-value { font-size: 20px; font-weight: 700; color: var(--text-primary); }

        .detail-highlights h3 { font-size: 18px; font-weight: 700; margin-bottom: 12px; }
        .detail-highlights ul { list-style: none; display: flex; flex-direction: column; gap: 12px; }
        .detail-highlights li { display: flex; align-items: flex-start; gap: 10px; color: var(--text-secondary); }
        .detail-highlights i { color: var(--secondary-green); margin-top: 3px; }

        .detail-actions { display: flex; flex-direction: column; gap: 12px; }
        .detail-action { display: flex; align-items: center; justify-content: center; gap: 10px; border: none; border-radius: 12px; padding: 14px; font-weight: 700; font-size: 16px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease; background: var(--white); color: var(--primary-blue); box-shadow: var(--shadow-sm); }
        .detail-action.primary { background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark)); color: var(--white); box-shadow: 0 14px 30px rgba(37,99,235,0.22); }
        .detail-action:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .detail-action.active { background: rgba(37,99,235,0.12); color: var(--primary-blue); }

        @media (max-width: 980px) {
            .property-detail-body { flex-direction: column; }
            .property-detail-sidebar { position: static; width: 100%; max-height: none; }
            .detail-gallery-primary img { height: 320px; }
        }

        @media (max-width: 600px) {
            .property-detail-modal .property-detail-content { padding: 26px 20px 32px; }
            .property-detail-header { flex-direction: column; align-items: flex-start; }
            .property-detail-title { font-size: 26px; }
            .property-detail-price { font-size: 26px; }
            .detail-gallery-thumbs { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .detail-thumb img { height: 90px; }
            .detail-stats { grid-template-columns: 1fr 1fr; }
        }

        .modal,
        .comparison-modal,
        .saved-searches-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.65);
            z-index: 1200;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal.active,
        .comparison-modal.active,
        .saved-searches-modal.active { display: flex; }

        .buyability-modal-content {
            background: var(--white);
            border-radius: 22px;
            width: min(720px, 92vw);
            max-height: 90vh;
            overflow-y: auto;
            padding: 42px 40px 48px;
            box-shadow: var(--shadow-xl);
            position: relative;
        }

        .buyability-header { margin-bottom: 24px; }
        .buyability-header h2 { font-size: 30px; font-weight: 800; margin-bottom: 8px; }
        .buyability-header p { color: var(--text-secondary); }

        .buyability-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; }
        .buyability-form .form-group { gap: 6px; }
        .buyability-form label { font-size: 13px; text-transform: uppercase; letter-spacing: 0.06em; font-weight: 700; color: var(--text-secondary); }
        .buyability-form input { padding: 12px; border-radius: 10px; border: 2px solid var(--border-color); font-size: 15px; }

        .buyability-actions { grid-column: 1 / -1; display: flex; gap: 14px; flex-wrap: wrap; margin-top: 4px; }
        .buyability-btn { background: var(--primary-blue); color: var(--white); border: none; padding: 14px 26px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .buyability-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .buyability-btn.secondary { background: rgba(37,99,235,0.1); color: var(--primary-blue); }
        .buyability-hint { font-size: 12px; color: var(--text-secondary); align-self: center; }

        .buyability-results { margin-top: 32px; background: var(--bg-gray); border-radius: 16px; padding: 24px; display: grid; gap: 18px; }
        .buyability-metric { display: flex; flex-direction: column; gap: 6px; }
        .buyability-metric span:first-child { font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
        .buyability-metric span:last-child { font-size: 24px; font-weight: 800; color: var(--text-primary); }
        .buyability-summary { font-size: 15px; color: var(--text-secondary); line-height: 1.6; }

        .modal-content,
        .comparison-modal-content,
        .saved-searches-content {
            background: var(--white);
            border-radius: 20px;
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            padding-bottom: 32px;
        }

        .comparison-modal-content { max-width: 1200px; padding: 42px; }
        .saved-searches-content { max-width: 640px; padding: 36px; }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            border: none;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--bg-gray);
            font-size: 22px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .close-modal:hover { background: var(--border-color); }

        .modal-header { padding: 40px 36px 20px; border-bottom: 1px solid var(--border-color); }
        .modal-header h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
        .modal-body { padding: 32px 36px; }
        .benefits-list { list-style: none; margin-bottom: 28px; }
        .benefits-list li { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .benefits-list li:last-child { border-bottom: none; }
        .benefits-list i { color: var(--secondary-green); font-size: 18px; }
        .modal form { display: flex; flex-direction: column; gap: 14px; }
        .modal input, .modal select { padding: 12px; border-radius: 10px; border: 2px solid var(--border-color); font-size: 15px; }
        .submit-btn { background: var(--primary-blue); color: var(--white); border: none; padding: 14px; border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; transition: background 0.2s ease; }
        .submit-btn:hover { background: var(--primary-dark); }

        .comparison-images { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .comparison-property-image { width: 100%; height: 200px; object-fit: cover; border-radius: 14px; }
        .comparison-table { width: 100%; }
        .comparison-row { display: grid; grid-template-columns: 200px repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; padding: 16px 0; border-bottom: 1px solid var(--border-color); }
        .comparison-label { font-weight: 700; color: var(--text-primary); }
        .comparison-value { color: var(--text-secondary); text-align: center; font-weight: 600; }

        .saved-search-item { background: var(--white); border-radius: 12px; border-left: 4px solid var(--primary-blue); padding: 18px 20px; margin-bottom: 16px; box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .saved-search-item:hover { transform: translateX(4px); box-shadow: var(--shadow-md); }
        .saved-search-name { font-weight: 700; margin-bottom: 6px; color: var(--primary-blue); }
        .saved-search-details { color: var(--text-secondary); font-size: 14px; margin-bottom: 6px; }
        .saved-search-alert { font-size: 12px; color: var(--secondary-green); font-weight: 600; }

        @media (max-width: 1024px) {
            .hero-title { font-size: 44px; }
            .hero-cta-buttons { flex-direction: column; align-items: stretch; }
            .hero-cta-btn { width: 100%; justify-content: center; box-shadow: 0 10px 24px rgba(0,0,0,0.2); }
            #propertyMap { height: 420px; }
            .map-layout { grid-template-columns: 1fr; }
            .map-sidebar { order: -1; max-height: 360px; margin-bottom: 20px; }
            .map-sidebar-list { max-height: 260px; }
            .map-wrapper { min-height: 500px; }
            .comparison-row { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .hero { padding: 90px 16px 70px; }
            .hero-title { font-size: 34px; }
            .hero-subtitle { font-size: 17px; }
            .hero-cta-buttons { gap: 12px; }
            .hero-cta-btn { padding: 13px 24px; font-size: 15px; }
            .search-form { grid-template-columns: 1fr; }
            .view-toggle { flex-direction: column; align-items: flex-start; }
            .map-wrapper { min-height: 440px; }
            .map-sidebar { max-height: none; }
            .map-sidebar-list { max-height: none; }
            .map-controls { top: auto; bottom: 24px; right: 24px; }
            .properties-grid { grid-template-columns: 1fr; }
            .live-notifications { right: 12px; max-width: 260px; }
            .comparison-content { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="live-notifications" id="liveNotifications"></div>

    <div class="top-banner">
        üè° <strong>New Listings Alert:</strong> 247 homes added this week in Central Florida!
        <a href="#" onclick="openModal('alertModal'); return false;">Get Instant Alerts ‚Üí</a>
    </div>

    <header class="header">
        <div class="header-content">
            <a class="logo" href="#">
                <i class="fas fa-home"></i>
                Central Florida Homes
            </a>
            <div class="header-actions">
                <button class="header-btn saved-searches-btn" onclick="openSavedSearches();">
                    <i class="fas fa-bookmark"></i> Saved Searches
                    <span class="saved-count" id="savedCount">0</span>
                </button>
                <button class="header-btn" onclick="openModal('alertModal');">
                    <i class="fas fa-bell"></i> Get Alerts
                </button>
            </div>
        </div>
    </header>

        <section class="hero">
            <div class="hero-content">
                <h1 class="hero-title">Find Your Dream Home in Central Florida</h1>
                <p class="hero-subtitle">Exclusive access to 10,000+ listings across Tampa, Orlando, Lakeland & Daytona Beach</p>

                <div class="hero-cta-buttons">
                    <button class="hero-cta-btn primary" type="button" onclick="focusMapView();">
                        <i class="fas fa-map-location-dot"></i> Explore the Interactive Map
                    </button>
                    <button class="hero-cta-btn secondary" type="button" onclick="openBuyAbilityModal();">
                        <i class="fas fa-calculator"></i> Run BuyAbility Calculator
                    </button>
                </div>

                <div class="search-container">
                    <div class="search-tabs">
                        <button class="search-tab active" type="button">Buy</button>
                        <button class="search-tab" type="button">Rent</button>
                        <button class="search-tab" type="button">Sell</button>
                        <span class="search-hint">Tip: Type a city like "Orlando" or a ZIP like 32801.</span>
                    </div>

                    <form class="search-form" onsubmit="return false;">
                        <div class="form-group">
                            <label for="locationFilter">City or ZIP</label>
                            <input class="form-input" id="locationFilter" list="locationOptions" placeholder="Type a city or ZIP" autocomplete="postal-code">
                            <datalist id="locationOptions">
                                <option value="Tampa"></option>
                                <option value="Orlando"></option>
                                <option value="Lakeland"></option>
                                <option value="Daytona Beach"></option>
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label for="priceFilter">Price Range</label>
                            <select class="form-select" id="priceFilter">
                                <option value="">Any Price</option>
                                <option value="0-300000">Under $300K</option>
                                <option value="300000-400000">$300K - $400K</option>
                                <option value="400000-500000">$400K - $500K</option>
                                <option value="500000-999999999">$500K+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="typeFilter">Property Type</label>
                            <select class="form-select" id="typeFilter">
                                <option value="">All Types</option>
                                <option value="House">House</option>
                                <option value="Condo">Condo</option>
                                <option value="Townhouse">Townhouse</option>
                                <option value="Multi-Family">Multi-Family</option>
                            </select>
                        </div>
                        <div class="form-group search-actions">
                            <button class="search-btn" type="button" onclick="applyFilters();">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <button class="search-btn save-search-btn" type="button" onclick="saveCurrentSearch();">
                                <i class="fas fa-bookmark"></i> Save Search
                            </button>
                        </div>
                    </form>
                </div>

                <div class="hero-stats">
                    <div class="hero-stat">
                        <span class="hero-stat-value" id="heroListings">‚Äî</span>
                        <span class="hero-stat-label">Active Listings</span>
                    </div>
                    <div class="hero-stat">
                        <span class="hero-stat-value" id="heroMedianPrice">‚Äî</span>
                        <span class="hero-stat-label">Median Price</span>
                    </div>
                    <div class="hero-stat">
                        <span class="hero-stat-value" id="heroTimeOnMarket">‚Äî</span>
                        <span class="hero-stat-label">Avg. Time on Market</span>
                    </div>
                    <div class="hero-stat">
                        <span class="hero-stat-value">2,450+</span>
                        <span class="hero-stat-label">Happy Homeowners</span>
                    </div>
                </div>
            </div>
        </section>

        <div class="view-toggle">
            <div class="property-count">
                <span id="propertyCount">0</span> Properties Found
            </div>
            <div class="view-buttons">
                <button class="view-btn active" type="button" data-view="list" onclick="switchView('list');">
                    <i class="fas fa-list"></i> List View
                </button>
                <button class="view-btn" type="button" data-view="map" onclick="switchView('map');">
                    <i class="fas fa-map"></i> Map View
                </button>
            </div>
        </div>

        <div class="map-layout" id="mapLayout">
            <div class="map-wrapper">
                <div id="propertyMap"></div>
                <div class="map-status" id="mapStatus">Map view loads in a moment‚Ä¶</div>
                <div class="map-controls" id="mapControls">
                    <button class="map-control-btn" id="drawBtn" type="button" onclick="toggleDrawMode();">
                        <i class="fas fa-draw-polygon"></i> Draw Boundary
                    </button>
                    <button class="map-control-btn" type="button" onclick="clearBoundary();">
                        <i class="fas fa-times"></i> Clear Shape
                    </button>
                </div>
            </div>
            <aside class="map-sidebar">
                <div class="map-sidebar-header">
                    <div class="map-sidebar-count" id="mapSidebarCount">Map View ‚Ä¢ 0 homes</div>
                    <div class="map-sidebar-summary" id="mapSidebarSummary">Median ‚Äî ‚Ä¢ Avg 0 bd / 0 ba</div>
                </div>
                <div class="map-sidebar-list" id="mapSidebarList">
                    <div class="map-sidebar-empty">Switch to map view to browse nearby listings.</div>
                </div>
            </aside>
        </div>

        <section class="properties-section">
            <div class="properties-grid" id="propertiesGrid"></div>
            <div class="load-more" id="loadMoreContainer">
                <button class="load-more-btn" id="loadMoreBtn" type="button" onclick="loadMoreProperties();">
                    Show More Homes
                </button>
            </div>
        </section>

        <div class="comparison-toolbar" id="comparisonToolbar">
            <div class="comparison-content">
                <div class="comparison-selected" id="comparisonSelected">
                    <span class="comparison-placeholder">Select homes to compare.</span>
                </div>
                <button class="compare-btn" id="compareBtn" type="button" disabled onclick="openComparisonModal();">
                    Compare Homes
                </button>
            </div>
        </div>

        <section class="agent-dashboard-section">
            <div class="dashboard-container">
                <div class="dashboard-preview">
                    <div class="dashboard-header">
                        <div>
                            <h2 class="dashboard-title">Agent Control Center</h2>
                            <p class="dashboard-subtitle">Supercharge your Central Florida business with real-time buyer intel</p>
                        </div>
                        <span class="demo-badge">LIVE DEMO</span>
                    </div>

                    <div class="dashboard-stats">
                        <div class="dashboard-stat-card">
                            <span class="dashboard-stat-value">42</span>
                            <span class="dashboard-stat-label">Active Leads This Month</span>
                        </div>
                        <div class="dashboard-stat-card">
                            <span class="dashboard-stat-value">18</span>
                            <span class="dashboard-stat-label">Showings Scheduled</span>
                        </div>
                        <div class="dashboard-stat-card">
                            <span class="dashboard-stat-value">$1.2M</span>
                            <span class="dashboard-stat-label">Pipeline Value</span>
                        </div>
                        <div class="dashboard-stat-card">
                            <span class="dashboard-stat-value">94%</span>
                            <span class="dashboard-stat-label">Response Rate</span>
                        </div>
                    </div>

                    <div class="dashboard-features">
                        <div class="dashboard-feature">
                            <i class="fas fa-users"></i>
                            <span>Lead nurture CRM with instant follow-up playbooks</span>
                        </div>
                        <div class="dashboard-feature">
                            <i class="fas fa-chart-line"></i>
                            <span>Market analytics with daily pricing heat-maps</span>
                        </div>
                        <div class="dashboard-feature">
                            <i class="fas fa-mobile-alt"></i>
                            <span>SMS + email automation for new buyer alerts</span>
                        </div>
                        <div class="dashboard-feature">
                            <i class="fas fa-calendar-check"></i>
                            <span>Smart scheduling synced with your MLS calendar</span>
                        </div>
                        <div class="dashboard-feature">
                            <i class="fas fa-bell"></i>
                            <span>Real-time buyer activity notifications</span>
                        </div>
                        <div class="dashboard-feature">
                            <i class="fas fa-file-alt"></i>
                            <span>One-click CMA & seller report generator</span>
                        </div>
                    </div>

                    <button class="demo-btn" type="button" onclick="openModal('alertModal');">Request Agent Demo</button>
                </div>
            </div>
        </section>

        <section class="neighborhood-section">
            <div class="neighborhood-container">
                <h2 class="section-title">Neighborhood Insights</h2>
                <div class="insights-grid">
                    <div class="insight-card">
                        <div class="insight-icon"><i class="fas fa-school"></i></div>
                        <h3 class="insight-title">Schools</h3>
                        <div class="insight-stats">
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Public Schools</span>
                                <span class="insight-stat-value"><span class="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span> 4.2</span>
                            </div>
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Private Options</span>
                                <span class="insight-stat-value">12 nearby</span>
                            </div>
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Student/Teacher</span>
                                <span class="insight-stat-value">15:1</span>
                            </div>
                        </div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-icon"><i class="fas fa-walking"></i></div>
                        <h3 class="insight-title">Walkability</h3>
                        <div class="insight-stats">
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Walk Score</span>
                                <span class="insight-stat-value">72 / 100</span>
                            </div>
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Transit Score</span>
                                <span class="insight-stat-value">65 / 100</span>
                            </div>
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Bike Score</span>
                                <span class="insight-stat-value">68 / 100</span>
                            </div>
                        </div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-icon"><i class="fas fa-shield-alt"></i></div>
                        <h3 class="insight-title">Safety</h3>
                        <div class="insight-stats">
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Crime Index</span>
                                <span class="insight-stat-value">Low</span>
                            </div>
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Neighborhood Rating</span>
                                <span class="insight-stat-value"><span class="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span> 4.5</span>
                            </div>
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Response Time</span>
                                <span class="insight-stat-value">&lt; 6 min</span>
                            </div>
                        </div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-icon"><i class="fas fa-utensils"></i></div>
                        <h3 class="insight-title">Amenities</h3>
                        <div class="insight-stats">
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Restaurants</span>
                                <span class="insight-stat-value">150+ nearby</span>
                            </div>
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Shopping</span>
                                <span class="insight-stat-value">28 centers</span>
                            </div>
                            <div class="insight-stat-row">
                                <span class="insight-stat-label">Parks</span>
                                <span class="insight-stat-value">15 parks</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="market-stats-section">
            <div class="section-header">
                <h2 class="section-title">Central Florida Market Insights</h2>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-sack-dollar"></i></div>
                    <span class="stat-value" id="statMedianPrice">‚Äî</span>
                    <p class="stat-description">Median sale price across Central Florida</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-house-circle-check"></i></div>
                    <span class="stat-value" id="statNewListings">‚Äî</span>
                    <p class="stat-description">Fresh listings added in the last 7 days</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-chart-area"></i></div>
                    <span class="stat-value" id="statAvgSqft">‚Äî</span>
                    <p class="stat-description">Average living space across active homes</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-tags"></i></div>
                    <span class="stat-value" id="statPriceReductions">‚Äî</span>
                    <p class="stat-description">Homes with price reductions this month</p>
                </div>
            </div>
        </section>

        <section class="cities-section">
            <div class="cities-grid">
                <div class="city-card" data-city="Tampa">
                    <div class="city-image">
                        <img src="https://images.unsplash.com/photo-1505843513577-22bb7d21e455?w=1200" alt="Tampa skyline">
                        <div class="city-overlay">
                            <div class="city-name">Tampa</div>
                            <div class="city-tagline">Waterfront living, thriving tech scene</div>
                        </div>
                    </div>
                    <div class="city-stats">
                        <div class="city-stat">
                            <span class="city-stat-label">Active Listings</span>
                            <span class="city-stat-value" data-stat="count">‚Äî</span>
                        </div>
                        <div class="city-stat">
                            <span class="city-stat-label">Median Price</span>
                            <span class="city-stat-value" data-stat="price">‚Äî</span>
                        </div>
                        <div class="city-stat">
                            <span class="city-stat-label">Median Sqft</span>
                            <span class="city-stat-value" data-stat="sqft">‚Äî</span>
                        </div>
                    </div>
                </div>

                <div class="city-card" data-city="Orlando">
                    <div class="city-image">
                        <img src="https://images.unsplash.com/photo-1519922639192-e73293ca430b?w=1200" alt="Orlando skyline">
                        <div class="city-overlay">
                            <div class="city-name">Orlando</div>
                            <div class="city-tagline">Theme parks, innovation and culture</div>
                        </div>
                    </div>
                    <div class="city-stats">
                        <div class="city-stat">
                            <span class="city-stat-label">Active Listings</span>
                            <span class="city-stat-value" data-stat="count">‚Äî</span>
                        </div>
                        <div class="city-stat">
                            <span class="city-stat-label">Median Price</span>
                            <span class="city-stat-value" data-stat="price">‚Äî</span>
                        </div>
                        <div class="city-stat">
                            <span class="city-stat-label">Median Sqft</span>
                            <span class="city-stat-value" data-stat="sqft">‚Äî</span>
                        </div>
                    </div>
                </div>

                <div class="city-card" data-city="Lakeland">
                    <div class="city-image">
                        <img src="https://images.unsplash.com/photo-1523419409543-0c1df022bdd1?w=1200" alt="Lakeland waterfront">
                        <div class="city-overlay">
                            <div class="city-name">Lakeland</div>
                            <div class="city-tagline">Historic charm meets new development</div>
                        </div>
                    </div>
                    <div class="city-stats">
                        <div class="city-stat">
                            <span class="city-stat-label">Active Listings</span>
                            <span class="city-stat-value" data-stat="count">‚Äî</span>
                        </div>
                        <div class="city-stat">
                            <span class="city-stat-label">Median Price</span>
                            <span class="city-stat-value" data-stat="price">‚Äî</span>
                        </div>
                        <div class="city-stat">
                            <span class="city-stat-label">Median Sqft</span>
                            <span class="city-stat-value" data-stat="sqft">‚Äî</span>
                        </div>
                    </div>
                </div>

                <div class="city-card" data-city="Daytona Beach">
                    <div class="city-image">
                        <img src="https://images.unsplash.com/photo-1545239351-1141bd82e8a6?w=1200" alt="Daytona Beach coast">
                        <div class="city-overlay">
                            <div class="city-name">Daytona Beach</div>
                            <div class="city-tagline">Oceanfront lifestyle on the Space Coast</div>
                        </div>
                    </div>
                    <div class="city-stats">
                        <div class="city-stat">
                            <span class="city-stat-label">Active Listings</span>
                            <span class="city-stat-value" data-stat="count">‚Äî</span>
                        </div>
                        <div class="city-stat">
                            <span class="city-stat-label">Median Price</span>
                            <span class="city-stat-value" data-stat="price">‚Äî</span>
                        </div>
                        <div class="city-stat">
                            <span class="city-stat-label">Median Sqft</span>
                            <span class="city-stat-value" data-stat="sqft">‚Äî</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="testimonials-section">
            <div class="testimonials-grid">
                <div class="testimonial-card">
                    <div class="testimonial-header">
                        <div class="testimonial-avatar">AL</div>
                        <div>
                            <div class="testimonial-name">Alex &amp; Lauren M.</div>
                            <div class="testimonial-location">Orlando, FL</div>
                        </div>
                    </div>
                    <div class="testimonial-rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                    <p class="testimonial-text">‚ÄúWe toured and compared three homes the same day they hit the market. The instant alerts and comparison tool helped us win our offer.‚Äù</p>
                </div>

                <div class="testimonial-card">
                    <div class="testimonial-header">
                        <div class="testimonial-avatar">JP</div>
                        <div>
                            <div class="testimonial-name">Jasmine P.</div>
                            <div class="testimonial-location">Tampa, FL</div>
                        </div>
                    </div>
                    <div class="testimonial-rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                    <p class="testimonial-text">‚ÄúMap view let us radius search around our kids‚Äô school and save multiple searches. Every morning I woke up to fresh homes in my inbox.‚Äù</p>
                </div>

                <div class="testimonial-card">
                    <div class="testimonial-header">
                        <div class="testimonial-avatar">RS</div>
                        <div>
                            <div class="testimonial-name">Robert S.</div>
                            <div class="testimonial-location">Daytona Beach, FL</div>
                        </div>
                    </div>
                    <div class="testimonial-rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                    <p class="testimonial-text">‚ÄúThe neighborhood insights and live notifications kept us ahead of competing buyers. We closed on our beach home in under 30 days.‚Äù</p>
                </div>
            </div>
        </section>

        <section class="cta-section">
            <div class="cta-content">
                <h2>Unlock Central Florida Before the Crowd</h2>
                <p>Get instant alerts for homes that match your wish list, see price drops first, and compare properties side-by-side with a local expert at your side.</p>
                <div class="cta-buttons">
                    <button class="cta-btn-primary" type="button" onclick="openModal('alertModal');">Get Instant Alerts</button>
                    <button class="cta-btn-secondary" type="button" onclick="openSavedSearches();">
                        <i class="fas fa-user-shield"></i> Talk with an Advisor
                    </button>
                </div>
            </div>
        </section>

        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Central Florida Homes</h3>
                    <p>Local experts helping you discover Tampa, Orlando, Lakeland, and Daytona Beach real estate before it hits the portals.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="#" onclick="switchView('list'); return false;">All Listings</a></li>
                        <li><a href="#" onclick="openModal('alertModal'); return false;">Instant Alerts</a></li>
                        <li><a href="#" onclick="openSavedSearches(); return false;">Saved Searches</a></li>
                        <li><a href="#" onclick="openModal('alertModal'); return false;">Agent Portal</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Top Cities</h3>
                    <ul class="footer-links">
                        <li><a href="#" onclick="applyFiltersFromFooter('Tampa'); return false;">Tampa Homes</a></li>
                        <li><a href="#" onclick="applyFiltersFromFooter('Orlando'); return false;">Orlando Homes</a></li>
                        <li><a href="#" onclick="applyFiltersFromFooter('Lakeland'); return false;">Lakeland Homes</a></li>
                        <li><a href="#" onclick="applyFiltersFromFooter('Daytona Beach'); return false;">Daytona Beach Homes</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Stay Connected</h3>
                    <div class="social-links">
                        <a class="social-link" href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a class="social-link" href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        <a class="social-link" href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a class="social-link" href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                &copy; <span id="footerYear"></span> Central Florida Homes. All rights reserved.
            </div>
        </footer>

        <div class="modal property-detail-modal" id="propertyDetailModal">
            <div class="property-detail-content">
                <button class="close-modal" type="button" onclick="closeModal('propertyDetailModal');">&times;</button>
                <div class="property-detail-header">
                    <div>
                        <span class="property-detail-city" id="detailCity"></span>
                        <h2 class="property-detail-title" id="detailTitle"></h2>
                        <div class="property-detail-address" id="detailAddress"></div>
                    </div>
                    <div class="property-detail-price" id="detailPrice"></div>
                </div>
                <div class="property-detail-body">
                    <div class="property-detail-main">
                        <div class="detail-gallery" id="detailGallery"></div>
                        <div class="detail-description-wrap">
                            <h3>About this home</h3>
                            <div class="detail-description" id="detailDescription"></div>
                        </div>
                    </div>
                    <aside class="property-detail-sidebar">
                        <div class="detail-stats" id="detailStats"></div>
                        <div class="detail-highlights">
                            <h3>Highlights</h3>
                            <ul id="detailHighlights"></ul>
                        </div>
                        <div class="detail-actions">
                            <button class="detail-action primary" id="detailScheduleBtn" type="button">
                                <i class="fas fa-calendar-check"></i> Schedule a Tour
                            </button>
                            <button class="detail-action" id="detailFavoriteBtn" type="button" aria-pressed="false">
                                <i class="far fa-heart"></i> Save Home
                            </button>
                            <button class="detail-action" id="detailCompareBtn" type="button" aria-pressed="false">
                                <i class="fas fa-balance-scale"></i> Add to Compare
                            </button>
                        </div>
                    </aside>
                </div>
            </div>
        </div>

        <div class="modal" id="alertModal">
            <div class="modal-content">
                <button class="close-modal" type="button" onclick="closeModal('alertModal');">&times;</button>
                <div class="modal-header">
                    <h2>Get Instant Alerts</h2>
                    <p>Be the first to know about new listings, price drops, and coming-soon homes.</p>
                </div>
                <div class="modal-body">
                    <ul class="benefits-list">
                        <li><i class="fas fa-bolt"></i><span>Alerts 2 hours before major portals update</span></li>
                        <li><i class="fas fa-envelope-open-text"></i><span>Personalized recommendations every morning</span></li>
                        <li><i class="fas fa-user-shield"></i><span>Local advisor support when you are ready to tour</span></li>
                    </ul>
                    <form id="alertsForm">
                        <input type="text" id="alertName" name="name" placeholder="Full Name" required>
                        <input type="email" id="alertEmail" name="email" placeholder="Email" required>
                        <select id="alertCity" name="city">
                            <option value="">Preferred City</option>
                            <option value="Tampa">Tampa</option>
                            <option value="Orlando">Orlando</option>
                            <option value="Lakeland">Lakeland</option>
                            <option value="Daytona Beach">Daytona Beach</option>
                        </select>
                        <button class="submit-btn" type="submit">Subscribe to Alerts</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal" id="buyAbilityModal">
            <div class="buyability-modal-content">
                <button class="close-modal" type="button" onclick="closeModal('buyAbilityModal');">&times;</button>
                <div class="buyability-header">
                    <h2>BuyAbility Calculator</h2>
                    <p>Estimate a confident price range based on your income, debts, and target terms before you tour.</p>
                </div>
                <form class="buyability-form" id="buyAbilityForm">
                    <div class="form-group">
                        <label for="buyIncome">Household Income (annual)</label>
                        <input type="number" id="buyIncome" name="income" min="0" placeholder="95000" required>
                    </div>
                    <div class="form-group">
                        <label for="buyDebt">Monthly Debt Payments</label>
                        <input type="number" id="buyDebt" name="debt" min="0" placeholder="1200">
                    </div>
                    <div class="form-group">
                        <label for="buyDownPayment">Cash for Down Payment</label>
                        <input type="number" id="buyDownPayment" name="downPayment" min="0" placeholder="60000">
                    </div>
                    <div class="form-group">
                        <label for="buyRate">Interest Rate (APR)</label>
                        <input type="number" id="buyRate" name="rate" min="0" step="0.01" placeholder="6.5">
                    </div>
                    <div class="form-group">
                        <label for="buyTaxes">Property Taxes (annual)</label>
                        <input type="number" id="buyTaxes" name="taxes" min="0" placeholder="4800">
                    </div>
                    <div class="form-group">
                        <label for="buyInsurance">Home Insurance (annual)</label>
                        <input type="number" id="buyInsurance" name="insurance" min="0" placeholder="1800">
                    </div>
                    <div class="form-group">
                        <label for="buyHoa">HOA Fees (monthly)</label>
                        <input type="number" id="buyHoa" name="hoa" min="0" placeholder="150">
                    </div>
                    <div class="buyability-actions">
                        <button class="buyability-btn" type="submit">Calculate BuyAbility</button>
                        <button class="buyability-btn secondary" type="button" onclick="resetBuyAbility();">Reset Inputs</button>
                        <span class="buyability-hint">We‚Äôll estimate a comfortable payment and price range ‚Äî no credit check.</span>
                    </div>
                </form>
                <div class="buyability-results" id="buyAbilityResults" hidden>
                    <div class="buyability-metric">
                        <span>Target Home Price</span>
                        <span id="buyAbilityPrice">‚Äî</span>
                    </div>
                    <div class="buyability-metric">
                        <span>Estimated Loan Amount</span>
                        <span id="buyAbilityLoan">‚Äî</span>
                    </div>
                    <div class="buyability-metric">
                        <span>Estimated Monthly Payment</span>
                        <span id="buyAbilityPayment">‚Äî</span>
                    </div>
                    <p class="buyability-summary" id="buyAbilitySummary"></p>
                    <div class="buyability-actions">
                        <button class="buyability-btn" type="button" onclick="openModal('alertModal');">Share With an Advisor</button>
                    </div>
                    <small style="color:#64748b;">Estimates use 30-year fixed assumptions with 28/36 debt-to-income benchmarks. Confirm with a licensed lender for exact figures.</small>
                </div>
            </div>
        </div>

        <div class="comparison-modal" id="comparisonModal">
            <div class="comparison-modal-content">
                <button class="close-modal" type="button" onclick="closeModal('comparisonModal');">&times;</button>
                <h2>Compare Homes</h2>
                <p>Analyze price, size, and features across your selected homes before you tour.</p>
                <div class="comparison-images" id="comparisonImages"></div>
                <div class="comparison-table" id="comparisonTable"></div>
            </div>
        </div>

        <div class="saved-searches-modal" id="savedSearchesModal">
            <div class="saved-searches-content">
                <button class="close-modal" type="button" onclick="closeModal('savedSearchesModal');">&times;</button>
                <h2>Saved Searches</h2>
                <p>Quickly re-run your favorite searches or set up new alerts.</p>
                <div id="savedSearchList"></div>
            </div>
        </div>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
        <script src="properties-data.js"></script>
        <script>
            (function () {
                const FALLBACK_IMAGE = 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=600';

                const state = {
                    allProperties: [],
                    filteredProperties: [],
                    displayedCount: 0,
                    displayBatchSize: 60,
                    favorites: new Set(),
                    selectedComparisons: [],
                    currentView: 'list',
                    mapInitialized: false,
                    map: null,
                    markersLayer: null,
                    markerIndex: new Map(),
                    activeMapId: null,
                    drawnLayer: null,
                    drawHandler: null,
                    zipCache: loadZipCache(),
                    savedSearches: loadSavedSearches(),
                    notificationIntervalId: null
                };

                const els = {
                    grid: document.getElementById('propertiesGrid'),
                    loadMoreContainer: document.getElementById('loadMoreContainer'),
                    propertyCount: document.getElementById('propertyCount'),
                    heroListings: document.getElementById('heroListings'),
                    heroMedianPrice: document.getElementById('heroMedianPrice'),
                    heroTimeOnMarket: document.getElementById('heroTimeOnMarket'),
                    map: document.getElementById('propertyMap'),
                    mapLayout: document.getElementById('mapLayout'),
                    mapStatus: document.getElementById('mapStatus'),
                    mapControls: document.getElementById('mapControls'),
                    drawBtn: document.getElementById('drawBtn'),
                    mapSidebarList: document.getElementById('mapSidebarList'),
                    mapSidebarCount: document.getElementById('mapSidebarCount'),
                    mapSidebarSummary: document.getElementById('mapSidebarSummary'),
                    comparisonToolbar: document.getElementById('comparisonToolbar'),
                    comparisonSelected: document.getElementById('comparisonSelected'),
                    compareBtn: document.getElementById('compareBtn'),
                    comparisonImages: document.getElementById('comparisonImages'),
                    comparisonTable: document.getElementById('comparisonTable'),
                    locationFilter: document.getElementById('locationFilter'),
                    priceFilter: document.getElementById('priceFilter'),
                    typeFilter: document.getElementById('typeFilter'),
                    savedCount: document.getElementById('savedCount'),
                    savedSearchList: document.getElementById('savedSearchList'),
                    liveNotifications: document.getElementById('liveNotifications'),
                    footerYear: document.getElementById('footerYear'),
                    alertModal: document.getElementById('alertModal'),
                    comparisonModal: document.getElementById('comparisonModal'),
                    savedModal: document.getElementById('savedSearchesModal'),
                    detailModal: document.getElementById('propertyDetailModal'),
                    detailTitle: document.getElementById('detailTitle'),
                    detailCity: document.getElementById('detailCity'),
                    detailPrice: document.getElementById('detailPrice'),
                    detailAddress: document.getElementById('detailAddress'),
                    detailGallery: document.getElementById('detailGallery'),
                    detailDescription: document.getElementById('detailDescription'),
                    detailStats: document.getElementById('detailStats'),
                    detailHighlights: document.getElementById('detailHighlights'),
                    detailFavoriteBtn: document.getElementById('detailFavoriteBtn'),
                    detailCompareBtn: document.getElementById('detailCompareBtn'),
                    detailScheduleBtn: document.getElementById('detailScheduleBtn'),
                    loadMoreBtn: document.getElementById('loadMoreBtn'),
                    statMedianPrice: document.getElementById('statMedianPrice'),
                    statNewListings: document.getElementById('statNewListings'),
                    statAvgSqft: document.getElementById('statAvgSqft'),
                    statPriceReductions: document.getElementById('statPriceReductions'),
                    propertiesSection: document.querySelector('.properties-section'),
                    buyAbilityModal: document.getElementById('buyAbilityModal'),
                    buyAbilityForm: document.getElementById('buyAbilityForm'),
                    buyAbilityResults: document.getElementById('buyAbilityResults'),
                    buyAbilityPrice: document.getElementById('buyAbilityPrice'),
                    buyAbilityLoan: document.getElementById('buyAbilityLoan'),
                    buyAbilityPayment: document.getElementById('buyAbilityPayment'),
                    buyAbilitySummary: document.getElementById('buyAbilitySummary')
                };

                const alertsForm = document.getElementById('alertsForm');
                const viewButtons = Array.from(document.querySelectorAll('.view-btn'));
                let mapRenderToken = 0;

                const ready = () => {
                    setFooterYear();
                    restoreFavorites();
                    updateSavedCount();
                    renderSavedSearches();
                    viewButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.view === state.currentView));

                    if (alertsForm) {
                        alertsForm.addEventListener('submit', handleAlertsSubmit);
                    }

                    if (els.buyAbilityForm) {
                        els.buyAbilityForm.addEventListener('submit', handleBuyAbilitySubmit);
                    }

                    resetBuyAbility();

                    document.addEventListener('keydown', event => {
                        if (event.key === 'Escape') {
                            closeModal('alertModal');
                            closeModal('comparisonModal');
                            closeModal('savedSearchesModal');
                            closeModal('propertyDetailModal');
                        }
                    });

                    document.addEventListener('click', event => {
                        if (event.target === els.alertModal) {
                            closeModal('alertModal');
                        }
                        if (event.target === els.comparisonModal) {
                            closeModal('comparisonModal');
                        }
                        if (event.target === els.savedModal) {
                            closeModal('savedSearchesModal');
                        }
                        if (event.target === els.detailModal) {
                            closeModal('propertyDetailModal');
                        }
                    });

                    loadProperties()
                        .then(properties => {
                            state.allProperties = Array.isArray(properties) ? properties : [];
                            state.filteredProperties = [...state.allProperties];
                            state.displayedCount = Math.min(state.displayBatchSize, state.filteredProperties.length);
                            updateHeroStats();
                            updateMarketStats();
                            updateCityStats();
                            renderProperties();
                            updatePropertyCount();
                            startNotifications();
                        })
                        .catch(error => {
                            console.error('Failed to load properties', error);
                            showErrorState('We could not load listings right now. Please refresh to try again.');
                        });
                };

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', ready);
                } else {
                    ready();
                }

                function renderProperties() {
                    if (!state.filteredProperties.length) {
                        els.grid.innerHTML = `<div class="empty-state">No homes match your filters yet. Try expanding your search range.</div>`;
                        if (els.loadMoreContainer) {
                            els.loadMoreContainer.style.display = 'none';
                        }
                        if (state.currentView === 'map') {
                            renderMapExperience([]);
                        }
                        return;
                    }

                    const limit = Math.min(state.displayedCount || state.displayBatchSize, state.filteredProperties.length);
                    state.displayedCount = limit;
                    const cardsHtml = state.filteredProperties.slice(0, limit).map(createPropertyCard).join('');
                    els.grid.innerHTML = cardsHtml;
                    if (els.loadMoreContainer) {
                        els.loadMoreContainer.style.display = state.filteredProperties.length > state.displayedCount ? 'flex' : 'none';
                    }
                    attachCardListeners();

                    if (state.currentView === 'map') {
                        renderMapExperience(state.filteredProperties);
                    }
                }

                function createPropertyCard(property) {
                    const id = String(property.id ?? '');
                    const isFavorite = state.favorites.has(id);
                    const isCompared = state.selectedComparisons.includes(id);
                    const price = formatPrice(property.price);
                    const statusBadge = renderStatusBadge(property.status);
                    const beds = formatBeds(property.beds);
                    const baths = formatBaths(property.baths);
                    const sqft = formatSqft(property.sqft);
                    const addressParts = [property.address, property.city, property.zip].filter(Boolean);
                    const address = addressParts.join(', ');
                    const photoCount = Array.isArray(property.images) ? property.images.length : 0;
                    const extraPhotos = photoCount > 1 ? photoCount - 1 : 0;

                    return `
                        <div class="property-card" data-id="${escapeHtml(id)}">
                            <div class="property-image">
                                <img src="${sanitizeUrl(property.image)}" alt="${escapeHtml(address || property.city || 'Central Florida home')}">
                                ${extraPhotos > 0 ? `<span class="property-photo-count">+${extraPhotos} photos</span>` : ''}
                                ${statusBadge}
                                <button type="button" class="compare-checkbox ${isCompared ? 'active' : ''}" data-action="compare" data-id="${escapeHtml(id)}" aria-pressed="${isCompared}">
                                    <i class="fas fa-balance-scale"></i>
                                </button>
                                <button type="button" class="favorite-btn ${isFavorite ? 'active' : ''}" data-action="favorite" data-id="${escapeHtml(id)}" aria-pressed="${isFavorite}">
                                    <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>
                                </button>
                            </div>
                            <div class="property-info">
                                <div class="property-price">${price}</div>
                                <div class="property-title">${escapeHtml(property.city || 'Central Florida')}</div>
                                <div class="property-address"><i class="fas fa-map-marker-alt"></i> ${escapeHtml(address)}</div>
                                <div class="property-features">
                                    <div class="feature"><i class="fas fa-bed"></i> ${beds} Beds</div>
                                    <div class="feature"><i class="fas fa-bath"></i> ${baths} Baths</div>
                                    <div class="feature"><i class="fas fa-ruler-combined"></i> ${sqft}</div>
                                </div>
                                <div class="property-footer">
                                    <span class="property-type">${escapeHtml(property.type || 'House')}</span>
                                    <button class="view-details-btn" type="button" data-action="details" data-id="${escapeHtml(id)}">View Details</button>
                                </div>
                            </div>
                        </div>`;
                }

                function renderStatusBadge(status) {
                    if (!status) {
                        return '';
                    }
                    const normalized = String(status).toLowerCase();
                    const badgeClass = {
                        'new': 'badge-new',
                        'hot': 'badge-hot',
                        'reduced': 'badge-reduced',
                        'pending': 'badge-pending',
                        'sold': 'badge-sold'
                    }[normalized];
                    if (!badgeClass) {
                        return '';
                    }
                    return `<span class="property-badge ${badgeClass}">${escapeHtml(statusLabel(normalized))}</span>`;
                }

                function statusLabel(value) {
                    switch (value) {
                        case 'new':
                            return 'New';
                        case 'hot':
                            return 'Hot Home';
                        case 'reduced':
                            return 'Price Drop';
                        case 'pending':
                            return 'Pending';
                        case 'sold':
                            return 'Sold';
                        default:
                            return 'For Sale';
                    }
                }

                function attachCardListeners() {
                    document.querySelectorAll('[data-action="favorite"]').forEach(button => {
                        button.addEventListener('click', () => toggleFavorite(button.dataset.id));
                    });
                    document.querySelectorAll('[data-action="compare"]').forEach(button => {
                        button.addEventListener('click', () => toggleComparison(button.dataset.id));
                    });
                    document.querySelectorAll('[data-action="details"]').forEach(button => {
                        button.addEventListener('click', () => viewPropertyDetails(button.dataset.id));
                    });
                }

                function toggleFavorite(id) {
                    if (!id) {
                        return;
                    }
                    const key = String(id);
                    if (state.favorites.has(key)) {
                        state.favorites.delete(key);
                    } else {
                        state.favorites.add(key);
                    }
                    saveFavorites();
                    const buttons = document.querySelectorAll(`[data-action="favorite"][data-id="${cssEscape(key)}"]`);
                    buttons.forEach(button => {
                        const isActive = state.favorites.has(key);
                        button.classList.toggle('active', isActive);
                        button.setAttribute('aria-pressed', String(isActive));
                        const icon = button.querySelector('i');
                        if (icon) {
                            icon.className = `${isActive ? 'fas' : 'far'} fa-heart`;
                        }
                    });
                    updateSidebarFavoriteState(key);
                    syncDetailActions(key);
                }

                function toggleComparison(id) {
                    if (!id) {
                        return;
                    }
                    const key = String(id);
                    const index = state.selectedComparisons.indexOf(key);
                    if (index >= 0) {
                        state.selectedComparisons.splice(index, 1);
                    } else {
                        if (state.selectedComparisons.length >= 3) {
                            addNotification({ name: 'Comparison Limit', action: 'You can compare up to 3 homes at once.', icon: 'fa-scale-balanced' });
                            return;
                        }
                        state.selectedComparisons.push(key);
                    }
                    updateComparisonToolbar();
                    const buttons = document.querySelectorAll(`[data-action="compare"][data-id="${cssEscape(key)}"]`);
                    buttons.forEach(button => {
                        const isActive = state.selectedComparisons.includes(key);
                        button.classList.toggle('active', isActive);
                        button.setAttribute('aria-pressed', String(isActive));
                    });
                    syncDetailActions(key);
                }

                function updateComparisonToolbar() {
                    if (!state.selectedComparisons.length) {
                        els.comparisonSelected.innerHTML = `<span class="comparison-placeholder">Select homes to compare.</span>`;
                        els.comparisonToolbar.classList.remove('active');
                        els.compareBtn.disabled = true;
                        return;
                    }

                    const itemsHtml = state.selectedComparisons.map(id => {
                        const property = state.allProperties.find(p => String(p.id) === id);
                        if (!property) {
                            return '';
                        }
                        const address = [property.address, property.city].filter(Boolean).join(', ');
                        return `
                            <div class="selected-property-card" data-id="${escapeHtml(id)}">
                                <img src="${sanitizeUrl(property.image)}" alt="${escapeHtml(address || 'Selected home')}">
                                <div>
                                    <strong>${escapeHtml(property.city || 'Central Florida')}</strong><br>
                                    <span>${formatPrice(property.price)}</span>
                                </div>
                                <button class="remove-comparison" type="button" data-action="remove-comparison" data-id="${escapeHtml(id)}" aria-label="Remove from comparison">&times;</button>
                            </div>`;
                    }).join('');

                    els.comparisonSelected.innerHTML = itemsHtml;
                    els.comparisonToolbar.classList.add('active');
                    els.compareBtn.disabled = state.selectedComparisons.length < 2;

                    els.comparisonSelected.querySelectorAll('[data-action="remove-comparison"]').forEach(button => {
                        button.addEventListener('click', () => toggleComparison(button.dataset.id));
                    });
                }

                function openComparisonModal() {
                    if (state.selectedComparisons.length < 2) {
                        addNotification({ name: 'Select Homes', action: 'Pick at least two homes to compare.', icon: 'fa-balance-scale' });
                        return;
                    }
                    renderComparisonModal();
                    openModal('comparisonModal');
                }

                function renderComparisonModal() {
                    const selectedProperties = state.selectedComparisons
                        .map(id => state.allProperties.find(p => String(p.id) === id))
                        .filter(Boolean);

                    if (!selectedProperties.length) {
                        els.comparisonImages.innerHTML = '';
                        els.comparisonTable.innerHTML = '';
                        return;
                    }

                    els.comparisonImages.innerHTML = selectedProperties.map(property => {
                        const address = [property.address, property.city].filter(Boolean).join(', ');
                        return `
                            <div>
                                <img class="comparison-property-image" src="${sanitizeUrl(property.image)}" alt="${escapeHtml(address || 'Home')}">
                                <p style="margin-top:12px;font-weight:600;">${escapeHtml(address || property.city || 'Central Florida')}</p>
                            </div>`;
                    }).join('');

                    const rows = [
                        { label: 'Price', accessor: property => formatPrice(property.price) },
                        { label: 'Beds', accessor: property => formatBeds(property.beds) },
                        { label: 'Baths', accessor: property => formatBaths(property.baths) },
                        { label: 'Square Feet', accessor: property => formatSqft(property.sqft) },
                        { label: 'Type', accessor: property => property.type || '‚Äî' },
                        { label: 'City', accessor: property => property.city || '‚Äî' },
                        { label: 'Status', accessor: property => statusLabel(String(property.status || '').toLowerCase()) }
                    ];

                    els.comparisonTable.innerHTML = rows.map(row => {
                        const values = selectedProperties.map(property => `<div class="comparison-value">${escapeHtml(row.accessor(property))}</div>`).join('');
                        return `<div class="comparison-row"><div class="comparison-label">${escapeHtml(row.label)}</div>${values}</div>`;
                    }).join('');
                }

                function viewPropertyDetails(id) {
                    const property = state.allProperties.find(item => String(item.id) === String(id));
                    if (!property) {
                        addNotification({ name: 'Listing Unavailable', action: 'We could not load that home right now. Try another property.', icon: 'fa-circle-info' });
                        return;
                    }
                    renderPropertyDetails(property);
                    openModal('propertyDetailModal');
                    if (els.detailModal) {
                        els.detailModal.dataset.currentId = String(property.id);
                        els.detailModal.scrollTop = 0;
                    }
                }

                function renderPropertyDetails(property) {
                    if (!els.detailModal) {
                        return;
                    }

                    const addressParts = [property.address, property.city, property.zip].filter(Boolean);
                    const address = addressParts.join(', ');

                    if (els.detailTitle) {
                        els.detailTitle.textContent = property.address || `${property.city || 'Central Florida'} Home`;
                    }
                    if (els.detailCity) {
                        const cityCopy = property.city ? `${property.city}${property.zip ? ` ‚Ä¢ ${property.zip}` : ''}` : 'Central Florida';
                        els.detailCity.textContent = cityCopy;
                    }
                    if (els.detailAddress) {
                        els.detailAddress.textContent = address || property.city || '';
                    }
                    if (els.detailPrice) {
                        els.detailPrice.textContent = formatPrice(property.price);
                    }
                    if (els.detailDescription) {
                        els.detailDescription.innerHTML = buildDetailDescription(property);
                    }
                    if (els.detailStats) {
                        els.detailStats.innerHTML = renderDetailStats(property);
                    }
                    if (els.detailHighlights) {
                        const highlights = generateHighlights(property);
                        els.detailHighlights.innerHTML = highlights.length
                            ? highlights.map(item => `<li><i class="fas fa-check-circle"></i><span>${escapeHtml(item)}</span></li>`).join('')
                            : `<li><i class="fas fa-check-circle"></i><span>Premium Central Florida living tailored for you.</span></li>`;
                    }

                    renderDetailGallery(property, address || property.city || 'Central Florida home');

                    if (els.detailFavoriteBtn) {
                        els.detailFavoriteBtn.onclick = () => toggleFavorite(property.id);
                    }
                    if (els.detailCompareBtn) {
                        els.detailCompareBtn.onclick = () => toggleComparison(property.id);
                    }
                    if (els.detailScheduleBtn) {
                        els.detailScheduleBtn.onclick = () => {
                            closeModal('propertyDetailModal');
                            openModal('alertModal');
                            addNotification({ name: 'Tour Requested', action: `We will connect you with a local expert in ${property.city || 'Central Florida'}.`, icon: 'fa-calendar-check' });
                        };
                    }

                    updateDetailButtons(property);
                }

                function renderDetailStats(property) {
                    const beds = formatBeds(property.beds);
                    const baths = formatBaths(property.baths);
                    const sqft = formatSqft(property.sqft);
                    const lot = formatLotSize(property.lotSize);
                    const yearBuilt = formatYearBuilt(property.yearBuilt);
                    const dom = formatDaysOnMarket(property.daysOnMarket);

                    const stats = [
                        { label: 'Bedrooms', value: beds !== '‚Äî' ? `${beds} bd` : '‚Äî' },
                        { label: 'Bathrooms', value: baths !== '‚Äî' ? `${baths} ba` : '‚Äî' },
                        { label: 'Square Feet', value: sqft },
                        { label: 'Lot Size', value: lot },
                        { label: 'Year Built', value: yearBuilt },
                        { label: 'Status', value: statusLabel(String(property.status || '').toLowerCase()) }
                    ];

                    if (dom !== '‚Äî') {
                        stats.push({ label: 'Days on Market', value: dom });
                    }

                    return stats.map(stat => `
                        <div class="detail-stat">
                            <span class="detail-stat-label">${escapeHtml(stat.label)}</span>
                            <span class="detail-stat-value">${escapeHtml(stat.value)}</span>
                        </div>
                    `).join('');
                }

                function renderDetailGallery(property, address) {
                    if (!els.detailGallery) {
                        return;
                    }
                    const galleryImages = Array.isArray(property.images) && property.images.length
                        ? property.images
                        : [property.image];
                    const images = galleryImages.map(src => sanitizeUrl(src));
                    if (!images.length) {
                        els.detailGallery.innerHTML = '';
                        return;
                    }
                    const [primary, ...rest] = images;
                    const thumbs = rest.slice(0, 6);
                    const primaryAlt = address || property.city || 'Property photo';
                    const safePrimary = escapeHtml(primary);
                    const thumbMarkup = thumbs.map(src => {
                        const safeSrc = escapeHtml(src);
                        return `
                            <button class="detail-thumb" type="button" data-src="${safeSrc}">
                                <img src="${safeSrc}" alt="${escapeHtml(primaryAlt)} thumbnail">
                            </button>
                        `;
                    }).join('');

                    els.detailGallery.innerHTML = `
                        <div class="detail-gallery-primary">
                            <img src="${safePrimary}" alt="${escapeHtml(primaryAlt)}" id="detailGalleryPrimaryImage">
                        </div>
                        ${thumbs.length ? `<div class="detail-gallery-thumbs">${thumbMarkup}</div>` : ''}
                    `;

                    const primaryImg = els.detailGallery.querySelector('#detailGalleryPrimaryImage');
                    els.detailGallery.querySelectorAll('.detail-thumb').forEach(button => {
                        button.addEventListener('click', () => {
                            const src = button.dataset.src;
                            if (src && primaryImg) {
                                primaryImg.src = src;
                            }
                        });
                    });
                }

                function buildDetailDescription(property) {
                    const description = (property.description || '').trim();
                    if (description) {
                        return description
                            .split('\n')
                            .map(paragraph => paragraph.trim())
                            .filter(Boolean)
                            .map(paragraph => `<p>${escapeHtml(paragraph)}</p>`)
                            .join('');
                    }

                    const sentences = [];
                    const typeLabel = property.type ? property.type.toLowerCase() : 'home';
                    const beds = formatBeds(property.beds);
                    const baths = formatBaths(property.baths);
                    const city = property.city || 'Central Florida';
                    const sqft = formatSqft(property.sqft);
                    const lot = formatLotSize(property.lotSize);

                    const overviewParts = [];
                    if (beds !== '‚Äî') {
                        overviewParts.push(`${beds}-bed`);
                    }
                    if (baths !== '‚Äî') {
                        overviewParts.push(`${baths}-bath`);
                    }
                    overviewParts.push(typeLabel);
                    sentences.push(`Experience this ${overviewParts.join(' ')} in ${city}, crafted for modern Florida living.`);

                    if (sqft !== '‚Äî') {
                        sentences.push(`Enjoy ${sqft.replace(' sq ft', ' square feet')} of flexible space filled with natural light and room to entertain.`);
                    }
                    if (lot !== '‚Äî' && lot !== '0 sq ft') {
                        sentences.push(`Outside, the property offers a ${lot} to savor breezy evenings and weekend gatherings.`);
                    }
                    sentences.push('Schedule your private tour to experience the finishes, flow, and neighborhood energy in person.');

                    return sentences.map(sentence => `<p>${escapeHtml(sentence)}</p>`).join('');
                }

                function generateHighlights(property) {
                    const highlights = [];
                    const dom = formatDaysOnMarket(property.daysOnMarket);
                    if (dom !== '‚Äî') {
                        highlights.push(dom);
                    }
                    if (property.type) {
                        highlights.push(`${property.type} lifestyle`);
                    }
                    const sqft = formatSqft(property.sqft);
                    if (sqft !== '‚Äî') {
                        highlights.push(`${sqft} interior`);
                    }
                    const lot = formatLotSize(property.lotSize);
                    if (lot !== '‚Äî' && lot !== '0 sq ft') {
                        highlights.push(`Lot size: ${lot}`);
                    }
                    const yearBuilt = formatYearBuilt(property.yearBuilt);
                    if (yearBuilt !== '‚Äî') {
                        highlights.push(`Built in ${yearBuilt}`);
                    }
                    if (property.city) {
                        highlights.push(`Minutes to ${property.city} favorites`);
                    }

                    const seen = new Set();
                    return highlights.filter(item => {
                        if (!item || seen.has(item)) {
                            return false;
                        }
                        seen.add(item);
                        return true;
                    });
                }

                function updateDetailButtons(property) {
                    if (!els.detailModal) {
                        return;
                    }
                    const key = String(property.id);
                    if (els.detailFavoriteBtn) {
                        const isFavorite = state.favorites.has(key);
                        els.detailFavoriteBtn.classList.toggle('active', isFavorite);
                        els.detailFavoriteBtn.innerHTML = `<i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i> ${isFavorite ? 'Saved Home' : 'Save Home'}`;
                        els.detailFavoriteBtn.setAttribute('aria-pressed', String(isFavorite));
                    }
                    if (els.detailCompareBtn) {
                        const isCompared = state.selectedComparisons.includes(key);
                        els.detailCompareBtn.classList.toggle('active', isCompared);
                        els.detailCompareBtn.innerHTML = `<i class="fas fa-balance-scale"></i> ${isCompared ? 'In Your Compare' : 'Add to Compare'}`;
                        els.detailCompareBtn.setAttribute('aria-pressed', String(isCompared));
                    }
                }

                function syncDetailActions(id) {
                    if (!els.detailModal || !els.detailModal.classList.contains('active')) {
                        return;
                    }
                    if (String(els.detailModal.dataset.currentId || '') !== String(id)) {
                        return;
                    }
                    const property = state.allProperties.find(item => String(item.id) === String(id));
                    if (property) {
                        updateDetailButtons(property);
                    }
                }

                function loadMoreProperties() {
                    if (state.displayedCount >= state.filteredProperties.length) {
                        return;
                    }
                    state.displayedCount = Math.min(state.displayedCount + state.displayBatchSize, state.filteredProperties.length);
                    renderProperties();
                }

                function applyFilters() {
                    const locationRaw = (els.locationFilter?.value || '').trim();
                    const location = locationRaw.toLowerCase();
                    const type = (els.typeFilter?.value || '').toLowerCase();
                    const priceRange = els.priceFilter?.value || '';
                    const [minPrice, maxPrice] = parsePriceRange(priceRange);

                    state.filteredProperties = state.allProperties.filter(property => {
                        if (location && !matchesLocation(property, location)) {
                            return false;
                        }
                        if (type && String(property.type || '').toLowerCase() !== type) {
                            return false;
                        }
                        if (priceRange) {
                            const price = Number(property.price) || 0;
                            if (price < minPrice || price > maxPrice) {
                                return false;
                            }
                        }
                        return true;
                    });

                    state.selectedComparisons = state.selectedComparisons.filter(id =>
                        state.filteredProperties.some(property => String(property.id) === id)
                    );

                    state.displayedCount = Math.min(state.displayBatchSize, state.filteredProperties.length);
                    renderProperties();
                    updatePropertyCount();
                    updateComparisonToolbar();
                    if (els.detailModal?.dataset?.currentId) {
                        syncDetailActions(els.detailModal.dataset.currentId);
                    }

                    if (state.currentView === 'map') {
                        renderMapExperience(state.filteredProperties);
                    }
                }

                function parsePriceRange(range) {
                    if (!range) {
                        return [0, Number.MAX_SAFE_INTEGER];
                    }
                    const [minRaw, maxRaw] = range.split('-');
                    const min = Number(minRaw);
                    const max = Number(maxRaw);
                    return [
                        Number.isFinite(min) ? min : 0,
                        Number.isFinite(max) ? max : Number.MAX_SAFE_INTEGER
                    ];
                }

                function updatePropertyCount() {
                    if (!els.propertyCount) {
                        return;
                    }
                    els.propertyCount.textContent = formatNumber(state.filteredProperties.length);
                }

                function updateHeroStats() {
                    if (els.heroListings) {
                        els.heroListings.textContent = formatNumber(state.allProperties.length);
                    }
                    const prices = state.allProperties
                        .map(property => Number(property.price))
                        .filter(value => Number.isFinite(value) && value > 0);
                    if (els.heroMedianPrice) {
                        els.heroMedianPrice.textContent = prices.length ? formatPrice(calculateMedian(prices)) : '‚Äî';
                    }
                    const days = state.allProperties
                        .map(property => Number(property.daysOnMarket))
                        .filter(value => Number.isFinite(value) && value > 0);
                    if (els.heroTimeOnMarket) {
                        els.heroTimeOnMarket.textContent = days.length
                            ? `${Math.round(average(days))} Days`
                            : '45 Days';
                    }
                }

                function updateMarketStats() {
                    if (!state.allProperties.length) {
                        return;
                    }
                    const prices = state.allProperties
                        .map(property => Number(property.price))
                        .filter(value => Number.isFinite(value) && value > 0);
                    if (els.statMedianPrice) {
                        els.statMedianPrice.textContent = prices.length ? formatPrice(calculateMedian(prices)) : '‚Äî';
                    }

                    const newListings = state.allProperties.filter(property => String(property.status || '').toLowerCase() === 'new').length;
                    if (els.statNewListings) {
                        els.statNewListings.textContent = formatNumber(newListings);
                    }

                    const sqftValues = state.allProperties
                        .map(property => Number(property.sqft))
                        .filter(value => Number.isFinite(value) && value > 0);
                    if (els.statAvgSqft) {
                        els.statAvgSqft.textContent = sqftValues.length
                            ? `${Math.round(average(sqftValues)).toLocaleString()} sq ft`
                            : '‚Äî';
                    }

                    const reductions = state.allProperties.filter(property => String(property.status || '').toLowerCase() === 'reduced').length;
                    if (els.statPriceReductions) {
                        els.statPriceReductions.textContent = formatNumber(reductions);
                    }
                }

                function updateCityStats() {
                    document.querySelectorAll('.city-card').forEach(card => {
                        const city = card.dataset.city;
                        if (!city) {
                            return;
                        }
                        const cityProperties = state.allProperties.filter(property => String(property.city || '').toLowerCase() === city.toLowerCase());
                        const countEl = card.querySelector('[data-stat="count"]');
                        const priceEl = card.querySelector('[data-stat="price"]');
                        const sqftEl = card.querySelector('[data-stat="sqft"]');

                        if (countEl) {
                            countEl.textContent = formatNumber(cityProperties.length);
                        }

                        const cityPrices = cityProperties
                            .map(property => Number(property.price))
                            .filter(value => Number.isFinite(value) && value > 0);
                        if (priceEl) {
                            priceEl.textContent = cityPrices.length ? formatPrice(calculateMedian(cityPrices)) : '‚Äî';
                        }

                        const citySqft = cityProperties
                            .map(property => Number(property.sqft))
                            .filter(value => Number.isFinite(value) && value > 0);
                        if (sqftEl) {
                            sqftEl.textContent = citySqft.length
                                ? `${Math.round(average(citySqft)).toLocaleString()} sq ft`
                                : '‚Äî';
                        }
                    });
                }

                async function renderMapExperience(properties) {
                    if (state.currentView !== 'map') {
                        return;
                    }
                    const list = Array.isArray(properties) ? properties : [];
                    const visibleResults = state.mapInitialized
                        ? await renderMapMarkers(list)
                        : list;
                    if (visibleResults === null) {
                        return;
                    }
                    const visible = Array.isArray(visibleResults) ? visibleResults : [];
                    renderMapSidebar(visible);
                }

                function renderMapSidebar(properties) {
                    if (!els.mapSidebarList) {
                        return;
                    }
                    const visible = Array.isArray(properties) ? properties : [];
                    if (!visible.length) {
                        els.mapSidebarList.innerHTML = `<div class="map-sidebar-empty">No homes match your filters on the map right now.</div>`;
                        updateMapSidebarHeader([], 0);
                        return;
                    }
                    const display = visible.slice(0, 24);
                    els.mapSidebarList.innerHTML = display.map(createSidebarCard).join('');
                    updateMapSidebarHeader(visible, display.length);
                    attachSidebarListeners();
                    if (state.activeMapId) {
                        const selector = `.map-sidebar-card[data-id="${cssEscape(String(state.activeMapId))}"]`;
                        if (els.mapSidebarList.querySelector(selector)) {
                            highlightSidebarCard(state.activeMapId, { scroll: false });
                        } else {
                            clearActiveMapProperty();
                        }
                    }
                }

                function updateMapSidebarHeader(properties, showingCount) {
                    if (els.mapSidebarCount) {
                        if (!properties.length) {
                            els.mapSidebarCount.textContent = 'Map View ‚Ä¢ 0 homes on the map';
                        } else {
                            const totalLabel = `Map View ‚Ä¢ ${formatNumber(properties.length)} homes on the map`;
                            const showingLabel = properties.length > showingCount
                                ? ` (showing first ${formatNumber(showingCount)})`
                                : '';
                            els.mapSidebarCount.textContent = `${totalLabel}${showingLabel}`;
                        }
                    }
                    if (els.mapSidebarSummary) {
                        if (!properties.length) {
                            els.mapSidebarSummary.textContent = 'Median ‚Äî ‚Ä¢ Avg ‚Äî bd / ‚Äî ba';
                            return;
                        }
                        const prices = properties
                            .map(property => Number(property.price))
                            .filter(value => Number.isFinite(value) && value > 0);
                        const medianPrice = prices.length ? formatPrice(calculateMedian(prices)) : '‚Äî';
                        const bedsAvg = averageField(properties, property => Number(property.beds));
                        const bathsAvg = averageField(properties, property => Number(property.baths));
                        const bedsLabel = bedsAvg !== null ? `${formatAverageValue(bedsAvg)} bd` : '‚Äî bd';
                        const bathsLabel = bathsAvg !== null ? `${formatAverageValue(bathsAvg)} ba` : '‚Äî ba';
                        els.mapSidebarSummary.textContent = `Median ${medianPrice} ‚Ä¢ Avg ${bedsLabel} / ${bathsLabel}`;
                    }
                }

                function createSidebarCard(property) {
                    const id = String(property.id ?? '');
                    const price = formatPrice(property.price);
                    const addressParts = [property.address, property.city, property.zip].filter(Boolean);
                    const address = addressParts.join(', ');
                    const beds = formatBeds(property.beds);
                    const baths = formatBaths(property.baths);
                    const sqft = formatSqft(property.sqft);
                    const favorite = state.favorites.has(id);
                    return `
                        <article class="map-sidebar-card" data-id="${escapeHtml(id)}" tabindex="0" aria-label="${escapeHtml(price)} at ${escapeHtml(address || property.city || 'Central Florida')}">
                            <img src="${sanitizeUrl(property.image)}" alt="${escapeHtml(address || property.city || 'Central Florida home')}">
                            <div class="map-sidebar-info">
                                <div class="map-sidebar-price">${price}</div>
                                <div class="map-sidebar-address">${escapeHtml(address || property.city || '')}</div>
                                <div class="map-sidebar-meta">
                                    <span>${beds !== '‚Äî' ? `${escapeHtml(beds)} bd` : '‚Äî bd'}</span>
                                    <span>${baths !== '‚Äî' ? `${escapeHtml(baths)} ba` : '‚Äî ba'}</span>
                                    <span>${escapeHtml(sqft)}</span>
                                </div>
                                <div class="map-sidebar-actions">
                                    <button class="map-sidebar-btn primary" type="button" data-action="sidebar-details" data-id="${escapeHtml(id)}">Details</button>
                                    <button class="map-sidebar-btn" type="button" data-action="sidebar-save" data-id="${escapeHtml(id)}">${favorite ? 'Saved' : 'Save'}</button>
                                </div>
                            </div>
                        </article>`;
                }

                function attachSidebarListeners() {
                    if (!els.mapSidebarList) {
                        return;
                    }
                    els.mapSidebarList.querySelectorAll('.map-sidebar-card').forEach(card => {
                        const id = card.dataset.id;
                        if (!id) {
                            return;
                        }
                        card.addEventListener('mouseenter', () => setActiveMapProperty(id, { scroll: false }));
                        card.addEventListener('focusin', () => setActiveMapProperty(id, { scroll: false }));
                        card.addEventListener('click', event => {
                            const action = event.target.closest('[data-action]');
                            if (action) {
                                return;
                            }
                            setActiveMapProperty(id, { center: true, scroll: true });
                            viewPropertyDetails(id);
                        });
                    });
                    els.mapSidebarList.querySelectorAll('[data-action="sidebar-details"]').forEach(button => {
                        button.addEventListener('click', event => {
                            event.preventDefault();
                            event.stopPropagation();
                            const id = button.dataset.id;
                            if (id) {
                                setActiveMapProperty(id, { center: true, scroll: true });
                                viewPropertyDetails(id);
                            }
                        });
                    });
                    els.mapSidebarList.querySelectorAll('[data-action="sidebar-save"]').forEach(button => {
                        button.addEventListener('click', event => {
                            event.preventDefault();
                            event.stopPropagation();
                            const id = button.dataset.id;
                            if (!id) {
                                return;
                            }
                            toggleFavorite(id);
                            updateSidebarFavoriteState(id);
                        });
                    });
                }

                function updateSidebarFavoriteState(id) {
                    if (!els.mapSidebarList) {
                        return;
                    }
                    const selector = `[data-action="sidebar-save"][data-id="${cssEscape(String(id))}"]`;
                    const button = els.mapSidebarList.querySelector(selector);
                    if (button) {
                        button.textContent = state.favorites.has(String(id)) ? 'Saved' : 'Save';
                    }
                }

                function setActiveMapProperty(id, options = {}) {
                    const key = String(id ?? '');
                    if (!key) {
                        return;
                    }
                    if (state.activeMapId && state.activeMapId !== key) {
                        removeSidebarHighlight(state.activeMapId);
                        removeMarkerHighlight(state.activeMapId);
                    }
                    state.activeMapId = key;
                    highlightSidebarCard(key, { scroll: Boolean(options.scroll) });
                    highlightPriceMarker(key);
                    if (options.center && state.mapInitialized && state.map && state.markerIndex.has(key)) {
                        const marker = state.markerIndex.get(key);
                        if (marker) {
                            const latLng = marker.getLatLng();
                            state.map.panTo(latLng, { animate: true, duration: 0.35 });
                        }
                    }
                }

                function highlightSidebarCard(id, options = {}) {
                    if (!els.mapSidebarList) {
                        return;
                    }
                    const selector = `.map-sidebar-card[data-id="${cssEscape(String(id))}"]`;
                    const card = els.mapSidebarList.querySelector(selector);
                    if (!card) {
                        return;
                    }
                    card.classList.add('active');
                    if (options.scroll) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }

                function removeSidebarHighlight(id) {
                    if (!id || !els.mapSidebarList) {
                        return;
                    }
                    const selector = `.map-sidebar-card[data-id="${cssEscape(String(id))}"]`;
                    const previous = els.mapSidebarList.querySelector(selector);
                    if (previous) {
                        previous.classList.remove('active');
                    }
                }

                function highlightPriceMarker(id) {
                    const marker = state.markerIndex.get(String(id));
                    if (!marker) {
                        return;
                    }
                    const element = marker.getElement();
                    if (element) {
                        const bubble = element.querySelector('.price-marker');
                        if (bubble) {
                            bubble.classList.add('highlight');
                        }
                    }
                }

                function removeMarkerHighlight(id) {
                    const marker = state.markerIndex.get(String(id));
                    if (!marker) {
                        return;
                    }
                    const element = marker.getElement();
                    if (element) {
                        const bubble = element.querySelector('.price-marker');
                        if (bubble) {
                            bubble.classList.remove('highlight');
                        }
                    }
                }

                function clearActiveMapProperty() {
                    if (!state.activeMapId) {
                        return;
                    }
                    removeSidebarHighlight(state.activeMapId);
                    removeMarkerHighlight(state.activeMapId);
                    state.activeMapId = null;
                }

                function switchView(view) {
                    if (!view) {
                        return;
                    }
                    state.currentView = view;
                    viewButtons.forEach(button => button.classList.toggle('active', button.dataset.view === view));

                    if (view === 'map') {
                        if (els.mapLayout) {
                            els.mapLayout.classList.add('active');
                        }
                        if (els.propertiesSection) {
                            els.propertiesSection.classList.add('hidden');
                        }
                        if (els.mapControls) {
                            els.mapControls.style.display = 'flex';
                        }
                        if (els.mapStatus) {
                            els.mapStatus.style.display = 'block';
                            els.mapStatus.textContent = 'Map view loads in a moment‚Ä¶';
                        }
                        if (!state.mapInitialized) {
                            initMap();
                        } else {
                            setTimeout(() => state.map.invalidateSize(), 150);
                            renderMapExperience(state.filteredProperties);
                        }
                    } else {
                        if (els.mapLayout) {
                            els.mapLayout.classList.remove('active');
                        }
                        if (els.propertiesSection) {
                            els.propertiesSection.classList.remove('hidden');
                        }
                        if (els.mapControls) {
                            els.mapControls.style.display = 'none';
                        }
                        if (els.mapStatus) {
                            els.mapStatus.style.display = 'none';
                        }
                        clearActiveMapProperty();
                    }
                }

                function initMap() {
                    if (state.mapInitialized || typeof L === 'undefined') {
                        return;
                    }
                    state.map = L.map(els.map, {
                        center: [28.5383, -81.3792],
                        zoom: 9,
                        zoomControl: false,
                        preferCanvas: true
                    });

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(state.map);

                    L.control.zoom({ position: 'bottomright' }).addTo(state.map);

                    state.markersLayer = L.layerGroup().addTo(state.map);
                    state.drawnLayer = new L.FeatureGroup();
                    state.map.addLayer(state.drawnLayer);

                    state.map.on(L.Draw.Event.CREATED, event => {
                        state.drawnLayer.clearLayers();
                        state.drawnLayer.addLayer(event.layer);
                        if (state.drawHandler && state.drawHandler.enabled && state.drawHandler.enabled()) {
                            state.drawHandler.disable();
                        }
                        els.drawBtn.classList.remove('active');
                        renderMapExperience(state.filteredProperties);
                    });

                    state.mapInitialized = true;
                    if (els.mapControls) {
                        els.mapControls.style.display = 'flex';
                    }
                    setTimeout(() => state.map.invalidateSize(), 100);
                    renderMapExperience(state.filteredProperties);
                }

                function toggleDrawMode() {
                    if (!state.mapInitialized) {
                        switchView('map');
                        addNotification({ name: 'Map Loading', action: 'Map view is loading. Try drawing again in a moment.', icon: 'fa-map' });
                        return;
                    }
                    if (!state.drawHandler) {
                        state.drawHandler = new L.Draw.Polygon(state.map, {
                            allowIntersection: false,
                            showArea: false,
                            shapeOptions: {
                                color: '#2563eb',
                                weight: 2,
                                opacity: 0.8,
                                fillOpacity: 0.08
                            }
                        });
                    }
                    if (state.drawHandler.enabled && state.drawHandler.enabled()) {
                        state.drawHandler.disable();
                        els.drawBtn.classList.remove('active');
                        els.mapStatus.textContent = 'Map view loads in a moment‚Ä¶';
                        return;
                    }
                    state.drawHandler.enable();
                    els.drawBtn.classList.add('active');
                    els.mapStatus.style.display = 'block';
                    els.mapStatus.textContent = 'Click to draw your preferred neighborhood boundary.';
                }

                function clearBoundary() {
                    if (!state.mapInitialized || !state.drawnLayer) {
                        return;
                    }
                    state.drawnLayer.clearLayers();
                    if (state.drawHandler && state.drawHandler.enabled && state.drawHandler.enabled()) {
                        state.drawHandler.disable();
                    }
                    els.drawBtn.classList.remove('active');
                    els.mapStatus.textContent = 'Map view loads in a moment‚Ä¶';
                    renderMapExperience(state.filteredProperties);
                }

                async function renderMapMarkers(properties) {
                    if (!state.mapInitialized || !state.map || typeof L === 'undefined') {
                        return [];
                    }
                    const token = ++mapRenderToken;
                    if (els.mapStatus) {
                        els.mapStatus.style.display = 'block';
                        els.mapStatus.textContent = 'Plotting map homes‚Ä¶';
                    }
                    state.markerIndex.clear();
                    state.markersLayer.clearLayers();

                    const visible = [];
                    const subset = properties.slice(0, Math.min(200, properties.length));
                    for (const property of subset) {
                        const coords = await getPropertyCoordinates(property);
                        if (token !== mapRenderToken) {
                            return null;
                        }
                        if (!coords) {
                            continue;
                        }
                        if (state.drawnLayer && state.drawnLayer.getLayers().length) {
                            const polygon = state.drawnLayer.getLayers()[0];
                            if (polygon && !polygon.getBounds().contains(L.latLng(coords[0], coords[1]))) {
                                continue;
                            }
                        }
                        const id = String(property.id ?? '');
                        const icon = L.divIcon({
                            className: '',
                            html: `<div class="price-marker-shell" data-marker-id="${escapeHtml(id)}"><div class="price-marker">${escapeHtml(formatPriceShort(property.price))}</div></div>`
                        });
                        const marker = L.marker(coords, { icon, riseOnHover: true });
                        marker.bindPopup(createPopupContent(property));
                        marker.on('click', () => {
                            setActiveMapProperty(id, { center: true, scroll: true });
                        });
                        marker.on('mouseover', () => setActiveMapProperty(id, { scroll: false }));
                        marker.addTo(state.markersLayer);
                        state.markerIndex.set(id, marker);
                        visible.push(property);
                    }

                    const hasMarkers = state.markersLayer.getLayers().length > 0;
                    if (!hasMarkers) {
                        if (els.mapStatus) {
                            els.mapStatus.style.display = 'block';
                            els.mapStatus.textContent = 'Map data not available for these results yet.';
                        }
                        clearActiveMapProperty();
                        return visible;
                    }

                    const bounds = state.markersLayer.getBounds();
                    if (bounds.isValid()) {
                        state.map.fitBounds(bounds.pad(0.2));
                    }
                    if (els.mapStatus) {
                        els.mapStatus.style.display = 'none';
                    }
                    if (state.activeMapId) {
                        highlightPriceMarker(state.activeMapId);
                    }
                    return visible;
                }

                async function getPropertyCoordinates(property) {
                    if (Number.isFinite(property.latitude) && Number.isFinite(property.longitude)) {
                        return [Number(property.latitude), Number(property.longitude)];
                    }
                    if (Array.isArray(property._latLng)) {
                        return property._latLng;
                    }
                    const zip = String(property.zip || '').trim();
                    if (!zip) {
                        return null;
                    }
                    if (state.zipCache[zip]) {
                        const cached = state.zipCache[zip];
                        const pair = [Number(cached.lat), Number(cached.lng)];
                        property._latLng = pair;
                        return pair;
                    }
                    const result = await geocodeZip(zip);
                    if (!result) {
                        return null;
                    }
                    state.zipCache[zip] = result;
                    saveZipCache();
                    const pair = [result.lat, result.lng];
                    property._latLng = pair;
                    return pair;
                }

                async function geocodeZip(zip) {
                    try {
                        const response = await fetch(`https://api.zippopotam.us/us/${zip}`);
                        if (!response.ok) {
                            return null;
                        }
                        const data = await response.json();
                        const place = data?.places?.[0];
                        if (!place) {
                            return null;
                        }
                        const lat = Number(place.latitude);
                        const lng = Number(place.longitude);
                        if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                            return null;
                        }
                        return { lat, lng };
                    } catch (error) {
                        console.warn('Failed to geocode zip', zip, error);
                        return null;
                    }
                }

                function createPopupContent(property) {
                    const price = formatPrice(property.price);
                    const address = [property.address, property.city, property.zip].filter(Boolean).join(', ');
                    return `
                        <div style="min-width:230px;">
                            <strong>${escapeHtml(price)}</strong>
                            <div style="margin:4px 0 8px;">${escapeHtml(address)}</div>
                            <div style="font-size:13px;color:#475569;">
                                Beds: ${escapeHtml(formatBeds(property.beds))} ‚Ä¢
                                Baths: ${escapeHtml(formatBaths(property.baths))} ‚Ä¢
                                Sq Ft: ${escapeHtml(formatSqft(property.sqft))}
                            </div>
                            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
                                <button style="background:#0f172a;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;flex:1;min-width:110px;" onclick="window.openPropertyDetails('${escapeHtml(String(property.id))}');">View Details</button>
                                <button style="background:#2563eb;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;flex:1;min-width:110px;" onclick="openModal('alertModal');">Schedule Tour</button>
                            </div>
                        </div>`;
                }

                function saveCurrentSearch() {
                    const location = (els.locationFilter?.value || '').trim();
                    const normalizedLocation = location.toLowerCase();
                    const priceRange = els.priceFilter?.value || '';
                    const type = els.typeFilter?.value || '';

                    if (!location && !priceRange && !type) {
                        addNotification({ name: 'Almost There', action: 'Choose at least one filter before saving a search.', icon: 'fa-filter-circle-xmark' });
                        return;
                    }

                    const exists = state.savedSearches.some(search =>
                        (search.location || search.city || '').toLowerCase() === normalizedLocation &&
                        search.priceRange === priceRange &&
                        search.type === type
                    );
                    if (exists) {
                        addNotification({ name: 'Saved Search', action: 'You already saved this search. Try adjusting filters.', icon: 'fa-bookmark' });
                        return;
                    }

                    const entry = {
                        id: String(Date.now()),
                        location,
                        city: location,
                        priceRange,
                        type,
                        createdAt: new Date().toISOString()
                    };
                    state.savedSearches.unshift(entry);
                    state.savedSearches = state.savedSearches.slice(0, 20);
                    saveSavedSearches();
                    updateSavedCount();
                    renderSavedSearches();
                    addNotification({ name: 'Saved Search', action: `${buildSearchTitle(entry)} alerts enabled.`, icon: 'fa-bookmark' });
                }

                function renderSavedSearches() {
                    if (!els.savedSearchList) {
                        return;
                    }
                    if (!state.savedSearches.length) {
                        els.savedSearchList.innerHTML = `<p style="color:#64748b;">No saved searches yet. Run a search and click ‚ÄúSave Search‚Äù.</p>`;
                        return;
                    }
                    els.savedSearchList.innerHTML = state.savedSearches.map(search => `
                        <div class="saved-search-item" data-id="${escapeHtml(search.id)}">
                            <div class="saved-search-name">${escapeHtml(buildSearchTitle(search))}</div>
                            <div class="saved-search-details">${escapeHtml(buildSearchSummary(search))}</div>
                            <div class="saved-search-alert">Instant alerts enabled</div>
                        </div>
                    `).join('');
                    els.savedSearchList.querySelectorAll('.saved-search-item').forEach(item => {
                        item.addEventListener('click', () => applySavedSearch(item.dataset.id));
                    });
                }

                function applySavedSearch(id) {
                    const search = state.savedSearches.find(entry => String(entry.id) === String(id));
                    if (!search) {
                        return;
                    }
                    const savedLocation = search.location || search.city || '';
                    if (els.locationFilter) {
                        els.locationFilter.value = savedLocation;
                    }
                    if (els.priceFilter) {
                        els.priceFilter.value = search.priceRange || '';
                    }
                    if (els.typeFilter) {
                        els.typeFilter.value = search.type || '';
                    }
                    applyFilters();
                    switchView('list');
                    closeModal('savedSearchesModal');
                }

                function openSavedSearches() {
                    renderSavedSearches();
                    openModal('savedSearchesModal');
                }

                function updateSavedCount() {
                    if (!els.savedCount) {
                        return;
                    }
                    els.savedCount.textContent = String(state.savedSearches.length);
                }

                function buildSearchTitle(search) {
                    const location = search.location || search.city || 'Central Florida';
                    return `${location} Homes`;
                }

                function buildSearchSummary(search) {
                    const parts = [];
                    parts.push(search.location || search.city || 'All Locations');
                    parts.push(formatPriceRange(search.priceRange));
                    parts.push(search.type || 'Any Type');
                    return parts.join(' ‚Ä¢ ');
                }

                function matchesLocation(property, filterValue) {
                    if (!filterValue) {
                        return true;
                    }
                    const raw = String(filterValue).trim().toLowerCase();
                    if (!raw) {
                        return true;
                    }
                    const city = String(property.city || '').toLowerCase();
                    const zipDigits = String(property.zip || '').replace(/\D/g, '');
                    const digitsOnly = raw.replace(/\D/g, '');
                    const compactNumeric = raw.replace(/[\s-]/g, '');
                    const isZipQuery = digitsOnly.length >= 3 && digitsOnly.length === compactNumeric.length;
                    if (isZipQuery) {
                        return zipDigits.startsWith(digitsOnly);
                    }
                    let primaryTerm = raw.split(',')[0].trim();
                    if (!primaryTerm) {
                        return true;
                    }
                    const refinedTerm = primaryTerm.replace(/\s+(fl|florida)$/i, '').trim() || primaryTerm;
                    return city.includes(refinedTerm);
                }

                function formatPriceRange(range) {
                    if (!range) {
                        return 'Any Price';
                    }
                    const [min, max] = parsePriceRange(range);
                    if (min === 0 && max === Number.MAX_SAFE_INTEGER) {
                        return 'Any Price';
                    }
                    if (min === 0) {
                        return `Under ${formatPrice(max)}`;
                    }
                    if (max === Number.MAX_SAFE_INTEGER || max >= 999999998) {
                        return `${formatPrice(min)}+`;
                    }
                    return `${formatPrice(min)} - ${formatPrice(max)}`;
                }

                function handleAlertsSubmit(event) {
                    event.preventDefault();
                    const form = event.target;
                    closeModal('alertModal');
                    if (form?.reset) {
                        form.reset();
                    }
                    addNotification({ name: 'Alerts Enabled', action: 'We will send the latest homes straight to your inbox.', icon: 'fa-envelope-open-text' });
                }

                function startNotifications() {
                    if (!els.liveNotifications) {
                        return;
                    }
                    if (state.notificationIntervalId) {
                        clearInterval(state.notificationIntervalId);
                    }
                    addNotification(generateNotification());
                    state.notificationIntervalId = setInterval(() => {
                        addNotification(generateNotification());
                    }, 9000);
                }

                function generateNotification() {
                    const baseNames = ['Alex', 'Jordan', 'Casey', 'Taylor', 'Morgan', 'Riley', 'Jamie', 'Avery'];
                    const property = state.allProperties[Math.floor(Math.random() * state.allProperties.length)] || {};
                    const city = property.city || 'Central Florida';
                    const name = `${baseNames[Math.floor(Math.random() * baseNames.length)]} in ${city}`;
                    const priceLabel = formatPrice(property.price);
                    const bedsValue = Number(property.beds);
                    const bathsValue = Number(property.baths);
                    const sqftLabel = formatSqft(property.sqft !== undefined ? property.sqft : 0);
                    const actions = [
                        `scheduled a private tour for ${priceLabel}`,
                        `favorited a ${(Number.isFinite(bedsValue) && bedsValue > 0 ? bedsValue : 3)}-bed home in ${city}`,
                        `asked about a ${(Number.isFinite(bathsValue) && bathsValue > 0 ? bathsValue : 2)}-bath in ${city}`,
                        `saved a search covering ${city}`,
                        `set alerts for price drops near ${city}`,
                        `is watching a ${sqftLabel} property in ${city}`
                    ];
                    return {
                        name,
                        action: actions[Math.floor(Math.random() * actions.length)],
                        icon: 'fa-bell'
                    };
                }

                function addNotification(payload) {
                    if (!els.liveNotifications || !payload) {
                        return;
                    }
                    const item = document.createElement('div');
                    item.className = 'notification-item';
                    item.innerHTML = `
                        <div class="notification-icon"><i class="fas ${payload.icon || 'fa-bell'}"></i></div>
                        <div>
                            <div class="notification-text">${escapeHtml(payload.name || 'Central Florida Homes')}</div>
                            <div class="notification-time">${escapeHtml(payload.action || 'Just now')}</div>
                        </div>
                    `;
                    els.liveNotifications.prepend(item);
                    while (els.liveNotifications.children.length > 4) {
                        els.liveNotifications.removeChild(els.liveNotifications.lastChild);
                    }
                    setTimeout(() => {
                        if (item && item.remove) {
                            item.remove();
                        }
                    }, 6500);
                }

                function setFooterYear() {
                    if (els.footerYear) {
                        els.footerYear.textContent = new Date().getFullYear();
                    }
                }

                function restoreFavorites() {
                    try {
                        const raw = localStorage.getItem('favoritePropertyIds');
                        if (raw) {
                            const ids = JSON.parse(raw);
                            if (Array.isArray(ids)) {
                                state.favorites = new Set(ids.map(String));
                            }
                        }
                    } catch (error) {
                        console.warn('Unable to restore favorites', error);
                    }
                }

                function saveFavorites() {
                    try {
                        localStorage.setItem('favoritePropertyIds', JSON.stringify(Array.from(state.favorites)));
                    } catch (error) {
                        console.warn('Unable to persist favorites', error);
                    }
                }

                function loadSavedSearches() {
                    try {
                        const raw = localStorage.getItem('savedSearches');
                        if (!raw) {
                            return [];
                        }
                        const parsed = JSON.parse(raw);
                        if (!Array.isArray(parsed)) {
                            return [];
                        }
                        return parsed.map(entry => {
                            if (entry && typeof entry === 'object' && !('location' in entry)) {
                                return { ...entry, location: entry.city || '' };
                            }
                            return entry;
                        });
                    } catch (error) {
                        console.warn('Unable to load saved searches', error);
                        return [];
                    }
                }

                function saveSavedSearches() {
                    try {
                        localStorage.setItem('savedSearches', JSON.stringify(state.savedSearches));
                    } catch (error) {
                        console.warn('Unable to persist saved searches', error);
                    }
                }

                function loadZipCache() {
                    try {
                        const raw = localStorage.getItem('zipCache');
                        return raw ? JSON.parse(raw) : {};
                    } catch (error) {
                        console.warn('Unable to load zip cache', error);
                        return {};
                    }
                }

                function saveZipCache() {
                    try {
                        localStorage.setItem('zipCache', JSON.stringify(state.zipCache));
                    } catch (error) {
                        console.warn('Unable to persist zip cache', error);
                    }
                }

                function showErrorState(message) {
                    els.grid.innerHTML = `<div class="empty-state">${escapeHtml(message)}</div>`;
                    if (els.loadMoreContainer) {
                        els.loadMoreContainer.style.display = 'none';
                    }
                }

                function formatPrice(value) {
                    const price = Number(value);
                    if (!Number.isFinite(price) || price <= 0) {
                        return 'Contact for price';
                    }
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        maximumFractionDigits: 0
                    }).format(price);
                }

                function formatBeds(value) {
                    const beds = Number(value);
                    if (!Number.isFinite(beds) || beds <= 0) {
                        return '‚Äî';
                    }
                    return Number.isInteger(beds) ? beds.toString() : beds.toFixed(1);
                }

                function formatBaths(value) {
                    const baths = Number(value);
                    if (!Number.isFinite(baths) || baths <= 0) {
                        return '‚Äî';
                    }
                    return Number.isInteger(baths) ? baths.toString() : baths.toFixed(1);
                }

                function formatSqft(value) {
                    const sqft = Number(value);
                    if (!Number.isFinite(sqft) || sqft <= 0) {
                        return '‚Äî';
                    }
                    return `${Math.round(sqft).toLocaleString()} sq ft`;
                }

                function formatLotSize(value) {
                    const lot = Number(value);
                    if (!Number.isFinite(lot) || lot <= 0) {
                        return '‚Äî';
                    }
                    if (lot >= 43560) {
                        const acres = lot / 43560;
                        const rounded = acres >= 1 ? acres.toFixed(1) : acres.toFixed(2);
                        return `${Number(rounded)} acres`;
                    }
                    return `${Math.round(lot).toLocaleString()} sq ft`;
                }

                function formatYearBuilt(value) {
                    const year = Number(value);
                    if (!Number.isFinite(year) || year <= 0) {
                        return '‚Äî';
                    }
                    return year.toString();
                }

                function formatDaysOnMarket(value) {
                    const days = Number(value);
                    if (!Number.isFinite(days) || days <= 0) {
                        return '‚Äî';
                    }
                    return `${days} day${days === 1 ? '' : 's'} on market`;
                }

                function formatNumber(value) {
                    const number = Number(value);
                    if (!Number.isFinite(number)) {
                        return '0';
                    }
                    return number.toLocaleString();
                }

                function formatPriceShort(value) {
                    const price = Number(value);
                    if (!Number.isFinite(price) || price <= 0) {
                        return 'View';
                    }
                    if (price >= 1000000) {
                        const millions = price / 1000000;
                        const precision = millions >= 10 ? 0 : 1;
                        return `$${millions.toFixed(precision)}M`;
                    }
                    if (price >= 1000) {
                        return `$${Math.round(price / 1000)}K`;
                    }
                    return formatCurrency(price, 0);
                }

                function averageField(collection, accessor) {
                    if (!Array.isArray(collection) || typeof accessor !== 'function') {
                        return null;
                    }
                    const values = collection
                        .map(accessor)
                        .filter(value => Number.isFinite(value) && value > 0);
                    if (!values.length) {
                        return null;
                    }
                    return average(values);
                }

                function formatAverageValue(value) {
                    if (!Number.isFinite(value) || value <= 0) {
                        return '‚Äî';
                    }
                    return Number.isInteger(value) ? value.toString() : value.toFixed(1);
                }

                function formatCurrency(value, digits = 0) {
                    const amount = Number(value);
                    if (!Number.isFinite(amount)) {
                        return '$0';
                    }
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: digits,
                        maximumFractionDigits: digits
                    }).format(amount);
                }

                function calculateMedian(values) {
                    if (!values.length) {
                        return 0;
                    }
                    const sorted = [...values].sort((a, b) => a - b);
                    const middle = Math.floor(sorted.length / 2);
                    if (sorted.length % 2 === 0) {
                        return (sorted[middle - 1] + sorted[middle]) / 2;
                    }
                    return sorted[middle];
                }

                function average(values) {
                    if (!values.length) {
                        return 0;
                    }
                    const total = values.reduce((sum, value) => sum + value, 0);
                    return total / values.length;
                }

                function sanitizeUrl(url) {
                    if (typeof url !== 'string' || !url.startsWith('http')) {
                        return FALLBACK_IMAGE;
                    }
                    return url;
                }

                function escapeHtml(value) {
                    return String(value ?? '')
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                }

                function cssEscape(value) {
                    const stringValue = String(value);
                    if (window.CSS && typeof window.CSS.escape === 'function') {
                        return window.CSS.escape(stringValue);
                    }
                    return stringValue.replace(/[^a-zA-Z0-9_-]/g, '\\$&');
                }

                function openModal(id) {
                    const modal = document.getElementById(id);
                    if (!modal) {
                        return;
                    }
                    modal.classList.add('active');
                }

                function closeModal(id) {
                    const modal = document.getElementById(id);
                    if (!modal) {
                        return;
                    }
                    modal.classList.remove('active');
                }

                function focusMapView() {
                    switchView('map');
                    setTimeout(() => {
                        if (els.mapLayout) {
                            els.mapLayout.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 220);
                }

                function openBuyAbilityModal() {
                    resetBuyAbility();
                    openModal('buyAbilityModal');
                    setTimeout(() => {
                        const incomeInput = els.buyAbilityForm?.querySelector('input[name="income"]');
                        incomeInput?.focus();
                    }, 120);
                }

                function handleBuyAbilitySubmit(event) {
                    event.preventDefault();
                    const form = event.target;
                    if (!form) {
                        return;
                    }
                    const income = Number(form.income?.value);
                    if (!Number.isFinite(income) || income <= 0) {
                        addNotification({ name: 'BuyAbility Calculator', action: 'Enter your annual household income to estimate affordability.', icon: 'fa-calculator' });
                        form.income?.focus();
                        return;
                    }
                    const monthlyIncome = income / 12;
                    const monthlyDebt = Math.max(0, Number(form.debt?.value) || 0);
                    const downPayment = Math.max(0, Number(form.downPayment?.value) || 0);
                    const taxesAnnual = Math.max(0, Number(form.taxes?.value) || 0);
                    const insuranceAnnual = Math.max(0, Number(form.insurance?.value) || 0);
                    const hoaFees = Math.max(0, Number(form.hoa?.value) || 0);
                    const rateInput = Number(form.rate?.value);
                    const interestRate = Number.isFinite(rateInput) && rateInput > 0 ? rateInput : 6.5;

                    const frontEndLimit = monthlyIncome * 0.28;
                    const backEndLimit = monthlyIncome * 0.36 - monthlyDebt;
                    const maxHousingPayment = Math.max(0, Math.min(frontEndLimit, backEndLimit));
                    if (maxHousingPayment <= 0) {
                        addNotification({ name: 'BuyAbility Calculator', action: 'Current debt levels exceed typical lending ratios. Try lowering monthly debts or entering joint income.', icon: 'fa-triangle-exclamation' });
                        return;
                    }

                    const monthlyTaxes = taxesAnnual / 12;
                    const monthlyInsurance = insuranceAnnual / 12;
                    const fixedHousingCosts = monthlyTaxes + monthlyInsurance + hoaFees;
                    const principalInterestBudget = maxHousingPayment - fixedHousingCosts;
                    if (principalInterestBudget <= 0) {
                        addNotification({ name: 'BuyAbility Calculator', action: 'Taxes, insurance, and HOA dues exceed the safe payment target. Try adjusting those inputs.', icon: 'fa-chart-line' });
                        return;
                    }

                    const monthlyRate = (interestRate / 100) / 12;
                    const termMonths = 360;
                    let loanAmount;
                    if (monthlyRate <= 0) {
                        loanAmount = principalInterestBudget * termMonths;
                    } else {
                        const factor = Math.pow(1 + monthlyRate, termMonths);
                        loanAmount = principalInterestBudget * (factor - 1) / (monthlyRate * factor);
                    }
                    loanAmount = Math.max(0, loanAmount);
                    const targetPrice = loanAmount + downPayment;
                    const totalMonthlyPayment = principalInterestBudget + fixedHousingCosts;
                    const frontRatio = (totalMonthlyPayment / monthlyIncome) * 100;
                    const backRatio = ((totalMonthlyPayment + monthlyDebt) / monthlyIncome) * 100;
                    const offerFloor = targetPrice * 0.9;
                    const offerCeiling = targetPrice * 1.05;

                    if (els.buyAbilityResults) {
                        els.buyAbilityResults.hidden = false;
                    }
                    if (els.buyAbilityPrice) {
                        els.buyAbilityPrice.textContent = formatCurrency(targetPrice, 0);
                    }
                    if (els.buyAbilityLoan) {
                        els.buyAbilityLoan.textContent = formatCurrency(loanAmount, 0);
                    }
                    if (els.buyAbilityPayment) {
                        els.buyAbilityPayment.textContent = formatCurrency(totalMonthlyPayment, 0);
                    }
                    if (els.buyAbilitySummary) {
                        els.buyAbilitySummary.textContent = `Ratios land near ${frontRatio.toFixed(1)}% front-end and ${backRatio.toFixed(1)}% back-end. Explore homes between ${formatCurrency(offerFloor, 0)} and ${formatCurrency(offerCeiling, 0)} for confident negotiating room.`;
                    }

                    addNotification({ name: 'BuyAbility Updated', action: 'Your personalized affordability range is ready in the modal.', icon: 'fa-chart-line' });
                }

                function resetBuyAbility() {
                    if (els.buyAbilityForm && typeof els.buyAbilityForm.reset === 'function') {
                        els.buyAbilityForm.reset();
                    }
                    if (els.buyAbilityResults) {
                        els.buyAbilityResults.hidden = true;
                    }
                    if (els.buyAbilityPrice) {
                        els.buyAbilityPrice.textContent = '‚Äî';
                    }
                    if (els.buyAbilityLoan) {
                        els.buyAbilityLoan.textContent = '‚Äî';
                    }
                    if (els.buyAbilityPayment) {
                        els.buyAbilityPayment.textContent = '‚Äî';
                    }
                    if (els.buyAbilitySummary) {
                        els.buyAbilitySummary.textContent = '';
                    }
                }

                function applyFiltersFromFooter(city) {
                    if (els.locationFilter) {
                        els.locationFilter.value = city || '';
                    }
                    if (els.priceFilter) {
                        els.priceFilter.value = '';
                    }
                    if (els.typeFilter) {
                        els.typeFilter.value = '';
                    }
                    applyFilters();
                    switchView('list');
                    const propertiesSection = document.querySelector('.properties-section');
                    if (propertiesSection) {
                        propertiesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }

                window.applyFilters = applyFilters;
                window.saveCurrentSearch = saveCurrentSearch;
                window.switchView = switchView;
                window.loadMoreProperties = loadMoreProperties;
                window.openModal = openModal;
                window.closeModal = closeModal;
                window.openComparisonModal = openComparisonModal;
                window.openSavedSearches = openSavedSearches;
                window.toggleDrawMode = toggleDrawMode;
                window.clearBoundary = clearBoundary;
                window.applyFiltersFromFooter = applyFiltersFromFooter;
                window.openPropertyDetails = viewPropertyDetails;
                window.focusMapView = focusMapView;
                window.openBuyAbilityModal = openBuyAbilityModal;
                window.resetBuyAbility = resetBuyAbility;
            })();
        </script>

    </body>
    </html>
